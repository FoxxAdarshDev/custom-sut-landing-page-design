<style>


  .modern-sale-container {
    background: linear-gradient(135deg, #ffffff 0%, #f0f4f8 50%, #e8f2ff 100%);
    min-height: 100vh;
    padding: 0px 20px 40px 20px;
    position: relative;
  }

  

  .sale-header {
    margin-bottom: 30px;
    padding: 40px 30px;
    background: linear-gradient(135deg, #ffffff 0%, rgba(178, 34, 52, 0.05) 20%, rgba(60, 59, 110, 0.05) 80%, #ffffff 100%);
    border-radius: 25px;
    color: #333;
    box-shadow: 0 8px 32px rgba(178, 34, 52, 0.1);
    position: relative;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 40px;
    min-height: 400px;
    border: 2px solid rgba(178, 34, 52, 0.2);
    overflow: hidden;
  }

  

  @keyframes pulse {
    0%, 100% { transform: scale(1); opacity: 0.3; }
    50% { transform: scale(1.1); opacity: 0.6; }
  }

  .sale-badge {
    background: linear-gradient(135deg, #b22234 0%, #3c3b6e 100%);
    color: white;
    padding: 12px 28px;
    border-radius: 30px;
    font-size: 0.85rem;
    font-weight: 800;
    display: inline-block;
    margin-bottom: 20px;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    box-shadow: 0 6px 20px rgba(178, 34, 52, 0.4);
    border: 2px solid rgba(255, 255, 255, 0.3);
    position: relative;
    overflow: hidden;
  }

  .sale-badge::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: left 0.8s ease;
  }

  .sale-badge:hover::before {
    left: 100%;
  }

  .hero-left {
    flex: 1;
    text-align: left;
    max-width: 500px;
  }

  .hero-right {
    flex: 0 0 350px;
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  .sale-header h1 {
    font-size: clamp(2rem, 5vw, 3.5rem);
    font-weight: 900;
    margin-bottom: 15px;
    background: linear-gradient(135deg, #3c3b6e 0%, #b22234 50%, #3c3b6e 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    letter-spacing: 1px;
    line-height: 1.1;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .sale-header h1 .gradient-text {
    background: linear-gradient(45deg, #b22234 0%, #3c3b6e 50%, #b22234 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    animation: patrioticGlow 3s ease-in-out infinite;
  }

  @keyframes patrioticGlow {
    0%, 100% { filter: brightness(1); }
    50% { filter: brightness(1.2); }
  }

  .sale-header .discount {
    font-size: clamp(1.8rem, 4vw, 2.8rem);
    font-weight: 900;
    background: linear-gradient(135deg, #b22234 0%, #ffffff 50%, #3c3b6e 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 15px;
    letter-spacing: 2px;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    opacity: 1;
  }

  .flag-wave {
    position: relative;
    display: inline-block;
  }

  .flag-wave::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(45deg, #b22234 25%, transparent 25%, transparent 50%, #b22234 50%, #b22234 75%, transparent 75%);
    background-size: 20px 20px;
    opacity: 0.1;
    z-index: -1;
    animation: slideFlag 3s linear infinite;
  }

  @keyframes slideFlag {
    0% { transform: translateX(-20px); }
    100% { transform: translateX(20px); }
  }

  .sale-subtitle {
    font-size: clamp(0.9rem, 1.8vw, 1.1rem);
    color: #667680;
    font-weight: 400;
    line-height: 1.4;
    margin-bottom: 25px;
  }

  .header-timer {
    background: linear-gradient(135deg, #3c3b6e 0%, #b22234 100%);
    border: 3px solid #ffffff;
    border-radius: 20px;
    padding: 25px 20px;
    width: 100%;
    box-shadow: 0 8px 25px rgba(178, 34, 52, 0.4);
    color: white;
    position: relative;
    overflow: hidden;
  }

  .header-timer::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: repeating-linear-gradient(90deg, #b22234 0px, #b22234 20px, #ffffff 20px, #ffffff 30px, #3c3b6e 30px, #3c3b6e 50px);
  }

  .header-timer-label {
    color: white;
    font-size: 1rem;
    font-weight: 800;
    margin-bottom: 15px;
    text-transform: uppercase;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    letter-spacing: 2px;
    white-space: nowrap;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
  }

  

  @keyframes patrioticPulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
  }

  .header-countdown {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 6px;
  }

  .header-countdown-unit {
    background: rgba(255, 255, 255, 0.9);
    border: 2px solid rgba(178, 34, 52, 0.3);
    border-radius: 12px;
    padding: 12px 8px;
    backdrop-filter: blur(10px);
    text-align: center;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  .header-countdown-unit::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: linear-gradient(90deg, #b22234 0%, #ffffff 50%, #3c3b6e 100%);
  }

  .header-countdown-unit:hover {
    transform: translateY(-3px);
    box-shadow: 0 4px 16px rgba(178, 34, 52, 0.3);
    border-color: #b22234;
  }

  .header-countdown-unit span {
    display: block;
    font-size: 1.8rem;
    font-weight: 900;
    background: linear-gradient(135deg, #b22234 0%, #3c3b6e 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    line-height: 1;
    margin-bottom: 4px;
    font-family: 'Arial', sans-serif;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .header-countdown-unit label {
    font-size: 0.65rem;
    font-weight: 700;
    color: #3c3b6e;
    text-transform: uppercase;
    letter-spacing: 0.8px;
  }

  .hero-tab-buttons {
    display: flex;
    flex-direction: column;
    gap: 12px;
    width: 100%;
  }

  .hero-tab-button {
    padding: 15px 20px;
    background: white;
    border: 2px solid #0071ce;
    border-radius: 12px;
    font-size: 1rem;
    font-weight: 700;
    color: #0071ce;
    cursor: pointer;
    transition: all 0.3s ease;
    text-transform: uppercase;
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    box-shadow: 0 2px 6px rgba(0, 113, 206, 0.1);
  }

  .hero-tab-button.active {
    background: #0071ce;
    border-color: #0071ce;
    color: white;
    transform: translateX(5px);
    box-shadow: 0 4px 12px rgba(0, 113, 206, 0.3);
  }

  .hero-tab-button:hover:not(.active) {
    background: #f0f8ff;
    border-color: #005ba6;
    color: #005ba6;
    transform: translateX(3px);
  }

  .shop-now-cta {
    background: #b22234;
    color: white;
    padding: 16px 40px;
    border: none;
    border-radius: 35px;
    font-weight: 900;
    font-size: 1.1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
    display: inline-block;
    text-transform: uppercase;
    letter-spacing: 1.5px;
    box-shadow: 0 10px 30px rgba(178, 34, 52, 0.5);
    position: relative;
    overflow: hidden;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
  }

  .shop-now-cta:hover {
    transform: translateY(-3px);
    box-shadow: 0 12px 35px rgba(220, 53, 69, 0.6);
    color: white;
    text-decoration: none;
    background: #a01e2e;
  }

  .shop-now-cta:before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: left 0.5s;
  }

  .shop-now-cta:hover:before {
    left: 100%;
  }

  .tabs-container {
    max-width: 100%;
    margin: 0 auto;
  }

  .sticky-tab-container {
    position: fixed;
    top: 0;
    left: 55%;
    transform: translateX(-55%) translateY(-100%);
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 50%, #e9ecef 100%);
    padding: 5px 5px;
    z-index: 800;
    box-shadow: 0 2px 20px rgba(0, 0, 0, 0.15);
    transition: transform 0.3s ease;
    border-bottom: 3px solid #0071ce;
    max-width: 1100px;
    width: calc(100% - 40px);
    border-radius: 0 0 15px 15px;
  }

  .sticky-tab-container.show {
    transform: translateX(-50%) translateY(0);
  }

  .sticky-content {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 20px;
  }

  .sticky-tabs {
    display: flex;
    gap: 10px;
  }

  .sticky-tab-button {
    padding: 10px 25px;
    background: #f8f9fa;
    border: 2px solid #dee2e6;
    border-radius: 20px;
    font-size: 1rem;
    font-weight: 700;
    color: #495057;
    cursor: pointer;
    transition: all 0.3s ease;
    text-transform: uppercase;
  }

  .sticky-tab-button.active {
    background: linear-gradient(45deg, #1E3A8A, #0071ce);
    color: white;
    border-color: #0071ce;
    transform: translateY(-1px);
    box-shadow: 0 3px 10px rgba(0, 113, 206, 0.3);
  }

  .sticky-timer {
    background: white;
    border: 2px solid #dc3545;
    border-radius: 10px;
    padding: 10px 15px;
    display: flex;
    align-items: center;
    gap: 15px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }

  .sticky-timer-label {
    color: #dc3545;
    font-size: 0.8rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    white-space: nowrap;
  }

  .sticky-countdown {
    display: flex;
    gap: 8px;
  }

  .sticky-countdown-unit {
    background: white;
    border: 1px solid #dc3545;
    border-radius: 4px;
    padding: 4px 6px;
    text-align: center;
    min-width: 35px;
  }

  .sticky-countdown-unit span {
    display: block;
    font-size: 1rem;
    font-weight: 900;
    color: #dc3545;
    line-height: 1;
    margin-bottom: 2px;
  }

  .sticky-countdown-unit label {
    font-size: 0.5rem;
    font-weight: 700;
    color: #dc3545;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .tab-buttons {
    display: flex;
    justify-content: center;
    margin-bottom: 40px;
    gap: 10px;
  }

  .tab-button {
    padding: 15px 40px;
    background: #f8f9fa;
    border: 2px solid #dee2e6;
    border-radius: 25px;
    font-size: 1.2rem;
    font-weight: 700;
    color: #495057;
    cursor: pointer;
    transition: all 0.3s ease;
    text-transform: uppercase;
  }

  .tab-button.active {
    background: linear-gradient(45deg, #1E3A8A, #0071ce);
    color: white;
    border-color: #0071ce;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 113, 206, 0.3);
  }

  .tab-button:hover:not(.active) {
    background: #e9ecef;
    border-color: #adb5bd;
    transform: translateY(-1px);
  }

  .tab-content {
    display: block;
  }

  .tab-content.active {
    display: block;
  }

  .collection-section {
    margin-bottom: 80px;
    background: white;
    border-radius: 25px;
    overflow: hidden;
    border: 2px solid rgba(220, 53, 69, 0.2);
    box-shadow: 0 8px 30px rgba(220, 53, 69, 0.1);
    position: relative;
  }

  .collection-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #dc3545 0%, #ffffff 50%, #0071b9 100%);
  }

  .collection-header {
    padding: 20px 40px;
    background: linear-gradient(135deg, #ffffff 0%, rgba(248, 250, 252, 0.8) 100%);
    display: flex;
    align-items: center;
    gap: 20px;
    min-height: auto;
    border-bottom: 1px solid rgba(220, 53, 69, 0.1);
  }

  .collection-header.reverse {
    flex-direction: row;
  }

  .collection-header-content {
    flex: 1;
  }

  .collection-title {
    font-size: 1.8rem;
    font-weight: 700;
    color: #0071b9;
    margin-bottom: 10px;
    line-height: 1.2;
  }

  .products-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 30px;
    padding: 40px;
  }

  .product-card {
    background: white;
    border-radius: 20px;
    overflow: hidden;
    transition: all 0.3s ease;
    border: 2px solid #0071b9;
    position: relative;
    max-width: 350px;
    width: 100%;
    margin: 0 auto;
    box-shadow: 0 4px 15px rgba(0, 113, 185, 0.1);
  }

  .product-card:hover {
    transform: translateY(-5px);
    border-color: #228cd1;
    box-shadow: 0 8px 25px rgba(0, 113, 185, 0.2);
  }

  .discount-badge {
    position: absolute;
    top: 12px;
    right: 12px;
    z-index: 10;
  }

  .discount-label {
    background: linear-gradient(135deg, #dc3545 0%, #b91c1c 100%) !important;
    color: white !important;
    padding: 8px 16px 8px 12px;
    font-weight: 700;
    font-size: 0.8rem;
    text-align: center;
    position: relative;
    display: inline-flex;
    align-items: center;
    min-height: 28px;
    border-radius: 15px 4px 4px 15px;
    box-shadow: 0 3px 10px rgba(220, 53, 69, 0.4);
    border: 1px solid #ffffff;
  }

  /* .discount-label::before {
    content: 'Discount';
    position: absolute;
    right: 100%;
    top: 0;
    bottom: 0;
    background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
    color: white;
    padding: 8px 10px;
    font-size: 0.65rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    border-radius: 15px 0 0 15px;
    white-space: nowrap;
    min-height: 28px;
    box-sizing: border-box;
  } */

  /* .discount-label::after {
    content: '';
    position: absolute;
    right: 100%;
    top: 100%;
    width: 0;
    height: 0;
    border-left: 6px solid #a91e2e;
    border-bottom: 6px solid transparent;
  } */

  @keyframes glow {
    from { opacity: 0.7; }
    to { opacity: 1; }
  }

  .product-image {
    height: 220px;
    background: linear-gradient(135deg, rgba(0, 113, 185, 0.05) 0%, rgba(220, 53, 69, 0.05) 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0px;
    border-bottom: 1px solid rgba(0, 113, 185, 0.1);
    position: relative;
  }

  .product-image img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
  }

  .product-content {
    padding: 15px;
  }

  .product-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: #0071b9;
    margin-bottom: 15px;
    line-height: 1.4;
    min-height: 52px;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
  }

  .product-title:hover {
    color: #228cd1;
    transform: translateY(-1px);
    text-shadow: 0 2px 4px rgba(0, 113, 185, 0.3);
  }

  .product-title-link {
    color: inherit;
    text-decoration: none;
    display: block;
  }

  .product-sku {
    color: #666;
    font-size: 0.85rem;
    margin-bottom: 2px; /* Reduced margin */
    font-weight: 500;
    display: flex;
    align-items: center;
    justify-content: flex-start;
    cursor: pointer;
    gap: 8px;
  }

  .copy-icon {
    width: 16px;
    height: 16px;
    cursor: pointer;
    color: #0071ce;
    transition: color 0.2s ease;
  }

  .copy-icon:hover {
    color: #005ba6;
  }

  .product-price {
    margin-bottom: 4px; /* Reduced margin */
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .original-price {
    text-decoration: line-through;
    color: #999;
    font-size: 0.9rem;
  }

  .sale-price {
    color: #0071ce;
    font-size: 1rem;
    font-weight: 700;
    text-decoration: line-through; /* Strikethrough */
    font-size: 0.9rem; /* Reduced font size */
  }

  .final-price {
    color: #dc3545;
    font-size: 1.6rem;
    font-weight: 900;
    margin-left: 10px;
  }

  .smart-savings {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 6px 8px; /* Further reduced padding */
    margin: 8px 0 12px 0; /* Reduced margins */
    border: 1px solid #e9ecef;
  }

  .smart-savings-header {
    display: flex;
    align-items: center;
    font-weight: 700;
    color: #495057;
    font-size: 0.85rem; /* Slightly smaller font */
    margin-bottom: 4px; /* Reduced margin */
    justify-content: space-between;
    cursor: pointer;
  }

  .savings-preview {
    font-size: 0.75rem; /* Smaller font */
    color: #6c757d;
    margin: 0; /* Removed margins */
    padding: 0; /* Removed padding */
    line-height: 1.2; /* Tighter line height */
  }

  .savings-option {
    background: #d1ecf1;
    border: 2px solid #bee5eb;
    border-radius: 6px;
    padding: 8px 10px;
    position: relative;
  }

  .savings-option.most-popular::before {
    content: 'MOST POPULAR';
    position: absolute;
    top: -8px;
    left: 50%;
    transform: translateX(-50%);
    background: #28a745;
    color: white;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 0.65rem;
    font-weight: 700;
  }

  .savings-text {
    color: #121212;
    font-size: 0.85rem;
    font-weight: 600;
    margin-bottom: 2px;
  }

  .savings-price {
    color: #495057;
    font-size: 0.8rem;
  }

  .savings-amount {
    font-weight: 700;
  }

  .savings-details {
    display: none;
    padding-top: 10px;
  }

  .smart-savings-toggle {
    cursor: pointer;
    font-size: 0.8rem;
    color: #0071ce;
    user-select: none;
  }

  .smart-savings.expanded .savings-details {
    display: block;
  }

  .smart-savings.expanded .smart-savings-toggle {
    transform: rotate(180deg);
  }

  .product-cta {
    background: linear-gradient(135deg, #0071b9 0%, #228cd1 100%);
    color: white;
    padding: 14px 28px;
    border: none;
    border-radius: 30px;
    font-weight: 700;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
    display: inline-block;
    text-align: center;
    width: 100%;
    text-transform: uppercase;
    letter-spacing: 0.8px;
    box-shadow: 0 4px 15px rgba(0, 113, 185, 0.3);
  }

  .product-cta:hover {
    background: linear-gradient(135deg, #005ba6 0%, #1a7bb5 100%);
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(0, 113, 185, 0.4);
    color: white;
    text-decoration: none;
  }

  .product-card {
    cursor: pointer;
  }

  /* Collection Anchor Links */
  .collection-anchor {
    color: inherit;
    text-decoration: none;
    position: relative;
    display: inline-block;
    cursor: pointer;
  }

  .collection-anchor:hover {
    color: #005ba6;
    text-decoration: none;
  }

  .collection-anchor::after {
    content: 'ðŸ”—';
    opacity: 0;
    margin-left: 8px;
    font-size: 0.8em;
    transition: opacity 0.3s ease;
  }

  .collection-anchor:hover::after {
    opacity: 1;
  }

  /* Smooth scrolling for the entire page */
  html {
    scroll-behavior: smooth;
  }

  /* Offset for fixed headers if any */
  .collection-section {
    scroll-margin-top: 20px;
  }

  /* Toast notification styles */
  .toast {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: #333;
    color: white;
    padding: 12px 24px;
    border-radius: 25px;
    font-size: 0.9rem;
    font-weight: 600;
    z-index: 1000;
    opacity: 0;
    transition: opacity 0.3s ease;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
  }

  .toast.show {
    opacity: 1;
  }

  @media (max-width: 768px) {
    .sticky-tab-container {
      width: calc(100% - 20px);
      padding: 12px 15px;
      left: 50%;
      transform: translateX(-50%) translateY(-100%);
    }

    .sticky-tab-container.show {
      transform: translateX(-50%) translateY(0);
    }

    .sticky-content {
      flex-direction: column;
      gap: 10px;
    }

    .sticky-tabs {
      gap: 5px;
    }

    .sticky-tab-button {
      padding: 8px 12px;
      font-size: 0.8rem;
    }

    .sticky-timer {
      padding: 8px 12px;
      gap: 10px;
    }

    .sticky-countdown {
      gap: 5px;
    }

    .sticky-countdown-unit {
      min-width: 30px;
      padding: 3px 4px;
    }

    .sticky-countdown-unit span {
      font-size: 0.9rem;
    }

    .sticky-countdown-unit label {
      font-size: 0.6rem;
    }

    .patriotic-sale-container {
      padding: 20px 10px;
    }

    .sale-header {
      padding: 25px 15px;
      flex-direction: column;
      text-align: center;
      min-height: auto;
      gap: 25px;
    }

    .hero-left {
      text-align: center;
      max-width: 100%;
    }

    .hero-right {
      flex: none;
      width: 100%;
      max-width: 350px;
      margin: 0 auto;
    }

    .header-timer {
      padding: 18px 15px;
    }

    .header-countdown {
      gap: 4px;
    }

    .header-countdown-unit {
      padding: 6px 4px;
    }

    .header-countdown-unit span {
      font-size: 1rem;
    }

    .header-countdown-unit label {
      font-size: 0.55rem;
    }

    .hero-tab-buttons {
      flex-direction: row;
      gap: 8px;
    }

    .hero-tab-button {
      padding: 12px 12px;
      font-size: 0.8rem;
    }

    .shop-now-cta {
      padding: 12px 25px;
      font-size: 0.9rem;
      margin-top: 15px;
    }

    .tab-buttons {
      flex-direction: column;
      align-items: center;
    }

    .tab-button {
      width: 100%;
      max-width: 300px;
      margin-bottom: 10px;
    }

    .products-grid {
      grid-template-columns: 1fr;
      gap: 20px;
      padding: 20px;
    }

    .collection-header {
      padding: 15px 20px;
      flex-direction: column;
      text-align: center;
      gap: 15px;
      min-height: auto;
    }

    .collection-title {
      font-size: 1.5rem;
    }
  }
  .discount-badge {
    position: absolute;
    top: -0px; /* Adjust as needed */
    right: -5px; /* Adjust as needed */
    z-index: 10;
}

/* Apple-style Popup Overlay */
.overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.4);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  z-index: 10000;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s ease;
}

.overlay.show {
  opacity: 1;
  visibility: visible;
}

/* Apple-style Popup */
.add-to-cart-popup {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(0.9);
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 20px;
  box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
  z-index: 10001;
  max-width: 800px;
  width: 90%;
  max-height: 90vh;
  overflow-y: auto;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.add-to-cart-popup.show {
  opacity: 1;
  visibility: visible;
  transform: translate(-50%, -50%) scale(1);
}

.popup-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px 24px 0 24px;
  margin-bottom: 20px;
  position: relative;
}

.popup-discount-badge {
  position: absolute;
  top: 10px;
  right: 60px;
  background: #dc3545;
  color: white;
  padding: 4px 12px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 700;
  text-transform: uppercase;
}

.popup-close {
  background: rgba(120, 120, 128, 0.12);
  border: none;
  border-radius: 50%;
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: background-color 0.2s ease;
  color: #666;
  font-size: 16px;
  font-weight: 500;
}

.popup-close:hover {
  background: rgba(120, 120, 128, 0.2);
}

.popup-content {
  padding: 0 24px 24px 24px;
}

/* Desktop Layout */
@media (min-width: 768px) {
  .popup-content {
    display: flex;
    gap: 24px;
    padding: 24px;
  }

  .popup-left-section {
    flex: 0 0 280px;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .popup-right-section {
    flex: 1;
    display: flex;
    flex-direction: column;
  }
}

.popup-product-image {
  width: 80px;
  height: 80px;
  background: #f8f9fa;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 20px auto;
  border: 1px solid rgba(0, 0, 0, 0.05);
}

@media (min-width: 768px) {
  .popup-product-image {
    width: 200px;
    height: 200px;
    margin: 0 0 15px 0;
  }
}

.popup-product-image img {
  max-width: 100%;
  max-height: 100%;
  object-fit: contain;
  border-radius: 12px;
}

.popup-product-title {
  font-size: 18px;
  font-weight: 600;
  color: #0071ce;
  margin-bottom: 8px;
  line-height: 1.3;
  text-align: center;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.popup-product-sku {
  font-size: 14px;
  color: #86868b;
  margin-bottom: 12px;
  text-align: center;
}

.popup-product-price {
  margin-bottom: 20px;
  text-align: center;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
}

.popup-original-price {
  text-decoration: line-through;
  color: #999;
  font-size: 0.9rem;
}

.popup-sale-price {
  color: #0071ce;
  font-size: 0.9rem;
  font-weight: 600;
  text-decoration: line-through;
}

.popup-final-price {
  color: #dc3545;
  font-size: 1.6rem;
  font-weight: 700;
}

.popup-smart-savings {
  background: #f8f9fa;
  border-radius: 12px;
  padding: 12px 16px;
  margin-bottom: 20px;
  border: 1px solid #e9ecef;
}

.popup-smart-savings-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  font-weight: 600;
  color: #495057;
  font-size: 14px;
  margin-bottom: 8px;
  cursor: pointer;
}

.popup-savings-preview {
  font-size: 12px;
  color: #6c757d;
  margin: 0;
  line-height: 1.2;
}

.popup-savings-details {
  display: none;
  padding-top: 12px;
}

.popup-smart-savings.expanded .popup-savings-details {
  display: block;
}

.popup-smart-savings.expanded .popup-smart-savings-toggle {
  transform: rotate(180deg);
}

.popup-savings-details {
  display: flex;
  /* flex-direction: column; */ /* Change to row */
  flex-direction: row; /* Change to row */
  gap: 8px;
  margin-top: 12px;
}

.popup-savings-option {
  background: #d1ecf1;
  border: 2px solid #bee5eb;
  border-radius: 8px;
  padding: 10px 8px;
  position: relative;
  cursor: pointer;
  transition: all 0.2s ease;
  text-align: center;
  flex: 1; /* Equal width distribution */
}

.popup-savings-option:hover {
  border-color: #0071ce;
  background: #e3f2fd;
}

.popup-savings-option.selected {
  border-color: #0071ce;
  background: #1976d2;
  color: white;
}

.popup-savings-option.selected .popup-savings-text,
.popup-savings-option.selected .popup-savings-price {
  color: white;
}

.popup-savings-label {
  position: absolute;
  top: -8px;
  left: 50%;
  transform: translateX(-50%);
  color: white;
  padding: 2px 6px;
  border-radius: 8px;
  font-size: 8px;
  font-weight: 700;
  white-space: nowrap;
}

.popup-savings-2 .popup-savings-label {
  background: #28a745;
}

.popup-savings-3 .popup-savings-label {
  background: #1976d2;
}

.popup-savings-5 .popup-savings-label {
  background: #ff5722;
}

.popup-savings-text {
  color: #121212;
  font-size: 12px;
  font-weight: 600;
  margin-bottom: 4px;
}

.popup-savings-price {
  color: #495057;
  font-size: 10px;
}

.popup-savings-amount {
  font-weight: 700;
}

.popup-quantity-section {
  margin-bottom: 24px;
}

.popup-quantity-label {
  font-size: 16px;
  font-weight: 500;
  color: #1d1d1f;
  margin-bottom: 12px;
  text-align: center;
  display: block;
}

.popup-quantity-controls {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 16px;
}

.popup-quantity-btn {
  background: rgba(0, 0, 0, 0.04);
  border: none;
  border-radius: 8px;
  width: 44px;
  height: 44px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s ease;
  font-size: 18px;
  font-weight: 500;
  color: #1d1d1f;
  user-select: none;
}

.popup-quantity-btn:hover {
  background: rgba(0, 0, 0, 0.08);
  transform: scale(1.05);
}

.popup-quantity-btn:disabled {
  opacity: 0.3;
  cursor: not-allowed;
  transform: none;
}

.popup-quantity-input {
  background: rgba(0, 0, 0, 0.04);
  border: none;
  border-radius: 8px;
  width: 60px;
  height: 44px;
  text-align: center;
  font-size: 16px;
  font-weight: 500;
  color: #1d1d1f;
  outline: none;
}

.popup-add-to-cart {
  background: #0071ce;
  color: white;
  border: none;
  border-radius: 12px;
  padding: 16px 24px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  width: 100%;
  margin-bottom: 20px;
}

.popup-add-to-cart:hover {
  background: #005ba6;
  transform: translateY(-1px);
}

.popup-recommended {
  border-top: 1px solid rgba(0, 0, 0, 0.1);
  padding-top: 20px;
  text-align: center;
}

.popup-recommended h3 {
  font-size: 16px;
  font-weight: 600;
  color: #1d1d1f;
  margin-bottom: 12px;
}

.popup-recommended p {
  font-size: 14px;
  color: #86868b;
  margin: 0;
}

/* Cart Notifications */
.cart-notification {
  position: fixed;
  top: 20px;
  right: 20px;
  background: white;
  border-radius: 12px;
  padding: 16px 20px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
  z-index: 10002;
  opacity: 0;
  transform: translateX(100%);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  border-left: 4px solid #28a745;
  max-width: 350px;
}

.cart-notification.error {
  border-left-color: #dc3545;
}

.cart-notification.coupon-notification {
  border-left-color: #ffd700;
  background: linear-gradient(135deg, #fff9e6 0%, #ffffff 100%);
}

.cart-notification.show {
  opacity: 1;
  transform: translateX(0);
}

.notification-content {
  display: flex;
  align-items: center;
  gap: 12px;
}

.notification-icon {
  width: 24px;
  height: 24px;
  background: #28a745;
  color: white;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  font-weight: 600;
  flex-shrink: 0;
}

.cart-notification.error .notification-icon {
  background: #dc3545;
}

.cart-notification.coupon-notification .notification-icon {
  background: #ffd700;
  color: #333;
  font-size: 16px;
}

.notification-text {
  font-size: 14px;
  font-weight: 500;
  color: #1d1d1f;
}

.cart-notification.coupon-notification .notification-text {
  color: #333;
}

/* Checkout Section */
.popup-checkout-section {
  margin-top: 20px;
  padding-top: 20px;
  border-top: 1px solid rgba(0, 0, 0, 0.1);
}

.popup-checkout-section.sticky-active {
  position: sticky;
  bottom: 0;
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px);
  margin: 20px -24px -24px -24px;
  padding: 12px 24px 16px 24px;
  border-top: 1px solid rgba(0, 0, 0, 0.1);
  z-index: 100;
}

/* Make Add to Cart button sticky when cart has items */
.popup-add-to-cart.sticky-active {
  position: sticky;
  bottom: 120px;
  z-index: 101;
  margin-bottom: 10px;
  box-shadow: 0 4px 12px rgba(0, 113, 206, 0.3);
}

@media (min-width: 768px) {
  .popup-checkout-section.sticky-active {
    position: sticky;
    bottom: 0;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    margin: 20px -24px -24px -24px;
    padding: 12px 24px 16px 24px;
    border-top: 1px solid rgba(0, 0, 0, 0.1);
  }

  .popup-add-to-cart.sticky-active {
    bottom: 140px;
  }
}

.checkout-buttons {
  display: flex;
  gap: 8px;
  margin-bottom: 16px;
}

.checkout-btn {
  flex: 1;
  padding: 10px 16px;
  border: none;
  border-radius: 8px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
}

.checkout-btn.primary {
  background: #0071ce;
  color: white;
}

.checkout-btn.primary:hover {
  background: #005ba6;
  transform: translateY(-1px);
}

.checkout-btn.secondary {
  background: rgba(0, 0, 0, 0.04);
  color: #1d1d1f;
}

.checkout-btn.secondary:hover {
  background: rgba(0, 0, 0, 0.08);
}

.checkout-icon {
  font-size: 16px;
}

/* Related Products */
.related-products-section {
  margin-top: 20px;
  padding-top: 20px;
  border-top: 1px solid rgba(0, 0, 0, 0.1);
}

.related-products-section h3 {
  font-size: 14px;
  font-weight: 600;
  color: #0071ce;
  margin-bottom: 12px;
  text-align: center;
}

.related-products-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: 10px;
  max-height: 400px;
  overflow-y: auto;
}

.related-products-grid::-webkit-scrollbar {
  width: 4px;
}

.related-products-grid::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 2px;
}

.related-products-grid::-webkit-scrollbar-thumb {
  background: #0071ce;
  border-radius: 2px;
}

.related-products-grid::-webkit-scrollbar-thumb:hover {
  background: #005ba6;
}

/* Left Column Related Products */
.left-related-products-section {
  margin-top: 20px;
  width: 100%;
}

.left-related-products-section h3 {
  font-size: 12px;
  font-weight: 600;
  color: #0071ce;
  margin-bottom: 10px;
  text-align: center;
}

.left-related-products-grid {
  display: flex;
  flex-direction: column;
  gap: 8px;
  max-height: 300px;
  overflow-y: auto;
  padding-right: 4px;
}

.left-related-products-grid::-webkit-scrollbar {
  width: 4px;
}

.left-related-products-grid::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 2px;
}

.left-related-products-grid::-webkit-scrollbar-thumb {
  background: #0071ce;
  border-radius: 2px;
}

.left-related-products-grid::-webkit-scrollbar-thumb:hover {
  background: #005ba6;
}

.left-related-product-card {
  background: #f8f9fa;
  border-radius: 8px;
  padding: 8px;
  cursor: pointer;
  transition: all 0.2s ease;
  border: 1px solid rgba(0, 0, 0, 0.05);
  display: flex;
  gap: 8px;
  align-items: center;
}

.left-related-product-card:hover {
  transform: translateY(-1px);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  border-color: #0071ce;
}

.left-related-product-image {
  width: 40px;
  height: 40px;
  background: white;
  border-radius: 4px;
  display: flex;
  align-items: center;
  justify-content: center;
  border: 1px solid rgba(0, 0, 0, 0.05);
  flex-shrink: 0;
}

.left-related-product-image img {
  max-width: 100%;
  max-height: 100%;
  object-fit: contain;
  border-radius: 2px;
}

.left-related-product-info {
  flex: 1;
  min-width: 0;
}

.left-related-product-info h4 {
  font-size: 9px;
  font-weight: 600;
  color: #1d1d1f;
  margin-bottom: 3px;
  line-height: 1.2;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.left-related-product-price {
  display: flex;
  align-items: center;
  gap: 4px;
  margin-bottom: 3px;
}

.left-related-sale-price {
  font-size: 8px;
  color: #999;
  text-decoration: line-through;
}

.left-related-final-price {
  font-size: 9px;
  font-weight: 600;
  color: #dc3545;
}

.left-related-discount-badge {
  background: #dc3545;
  color: white;
  padding: 2px 6px;
  border-radius: 8px;
  font-size: 7px;
  font-weight: 600;
  display: inline-block;
  width: auto;
  max-width: 50px;
  text-align: center;
}

.related-product-card {
  background: #f8f9fa;
  border-radius: 8px;
  padding: 10px;
  cursor: pointer;
  transition: all 0.2s ease;
  border: 1px solid rgba(0, 0, 0, 0.05);
}

.related-product-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  border-color: #0071ce;
}

.related-product-image {
  width: 50px;
  height: 50px;
  background: white;
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 8px auto;
  border: 1px solid rgba(0, 0, 0, 0.05);
}

.related-product-image img {
  max-width: 100%;
  max-height: 100%;
  object-fit: contain;
  border-radius: 4px;
}

.related-placeholder {
  font-size: 20px;
  color: #666;
}

.related-product-info h4 {
  font-size: 12px;
  font-weight: 600;
  color: #1d1d1f;
  margin-bottom: 6px;
  line-height: 1.2;
  text-align: center;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
  min-height: 28px;
}

.related-product-price {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  margin-bottom: 6px;
}

.related-sale-price {
  font-size: 10px;
  color: #999;
  text-decoration: line-through;
}

.related-final-price {
  font-size: 12px;
  font-weight: 600;
  color: #dc3545;
}

.related-discount-badge {
  background: #dc3545;
  color: white;
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 9px;
  font-weight: 600;
  text-align: center;
  display: inline-block;
  width: auto;
  max-width: 60px;
}

/* Validation Modal Styles */
.popup-validation-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 10003;
  display: flex;
  align-items: center;
  justify-content: center;
}

.popup-validation-overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(5px);
}

.popup-validation-content {
  background: white;
  border-radius: 12px;
  max-width: 500px;
  width: 90%;
  position: relative;
  z-index: 1;
  box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
}

.popup-validation-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px 24px;
  border-bottom: 1px solid #e0e0e0;
}

.popup-validation-header h3 {
  margin: 0;
  color: #1d1d1f;
  font-size: 18px;
}

.popup-validation-close {
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
  color: #666;
}

.popup-validation-body {
  padding: 24px;
}

.validation-info {
  margin-bottom: 20px;
}

.validation-info p {
  margin: 8px 0;
  font-size: 14px;
}

.amount-needed {
  color: #dc3545;
  font-weight: 600;
}

.security-notice {
  background: #e3f2fd;
  border: 1px solid #1976d2;
  border-radius: 8px;
  padding: 12px 16px;
  display: flex;
  align-items: flex-start;
  gap: 10px;
}

.security-icon {
  font-size: 16px;
}

.security-text {
  font-size: 13px;
  color: #1976d2;
  line-height: 1.4;
}

.popup-validation-footer {
  padding: 20px 24px;
  border-top: 1px solid #e0e0e0;
  display: flex;
  gap: 12px;
  justify-content: flex-end;
}

.validation-btn {
  padding: 12px 20px;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
}

.validation-btn.primary {
  background: #0071ce;
  color: white;
}

.validation-btn.primary:hover {
  background: #005ba6;
}

.validation-btn.secondary {
  background: #f5f5f5;
  color: #666;
}

.validation-btn.secondary:hover {
  background: #e0e0e0;
}

/* Popup validation warning */
.popup-validation-warning {
  background: #fff3cd;
  border: 1px solid #ffeaa7;
  border-radius: 6px;
  padding: 8px 12px;
  margin-bottom: 12px;
  display: flex;
  align-items: flex-start;
  gap: 8px;
}

.validation-icon {
  font-size: 16px;
  color: #856404;
}

.validation-content {
  flex: 1;
}

.validation-title {
  font-weight: 600;
  color: #856404;
  margin: 0 0 4px 0;
  font-size: 14px;
}

.validation-message {
  margin: 0;
  font-size: 13px;
  color: #856404;
  line-height: 1.4;
}

/* Disabled checkout button */
.checkout-btn.disabled {
  background: #f5f5f5;
  color: #999;
  cursor: not-allowed;
}

.checkout-btn.disabled:hover {
  background: #f5f5f5;
  transform: none;
}

/* Product variants and quantity styles */
  .product-variants-quantity-container {
    display: flex;
    gap: 20px;
    margin-bottom: 2px;
    align-items: flex-end;
  }

  .product-variants {
    flex: 1;
    margin-bottom: 0;
  }

  .product-variants label {
    display: block;
    font-size: 0.9rem;
    font-weight: 600;
    color: #333;
    margin-bottom: 5px;
  }

  .variant-selector {
    width: 100%;
    padding: 8px 12px;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    font-size: 0.9rem;
    background: white;
    cursor: pointer;
    /* padding-bottom:0px!important; */
    transition: border-color 0.3s ease;
  }

  .variant-selector:focus {
    outline: none;
    border-color: #0071ce;
  }

  .product-quantity {
    flex: 0 0 auto;
    margin-bottom: 0;
    min-width: 150px;
  }

  .product-quantity label {
    display: block;
    font-size: 0.9rem;
    font-weight: 600;
    color: #333;
    margin-bottom: 5px;
  }

  .quantity-controls {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .quantity-controls button {
    background: #f8f9fa;
    border: 2px solid #e9ecef;
    border-radius: 6px;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    color: #333;
  }

  .quantity-controls button:hover {
    background: #e9ecef;
    border-color: #0071ce;
    color:#121212;
  }

  .quantity-input {
    width: 60px;
    height: 36px;
    text-align: center;
    border: 2px solid #e9ecef;
    border-radius: 6px;
    font-size: 1rem;
    font-weight: 600;
  }

  .product-actions {
    display: flex;
    gap: 8px;
    margin-top: 10px;
  }

  .product-actions .product-cta {
    flex: 1;
    padding: 0px;
    padding-left:5px;
    padding-right:5px;
    padding-top:10px;
    padding-bottom:10px;
    font-size: 0.85rem;
    border-radius: 20px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    transition: all 0.3s ease;
    border: none;
    cursor: pointer;
  }

  .add-to-cart-btn {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%) !important;
    color: white !important;
    box-shadow: 0 3px 10px rgba(40, 167, 69, 0.3);
  }

  .add-to-cart-btn:hover {
    background: linear-gradient(135deg, #218838 0%, #1ba085 100%) !important;
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
  }

  .shop-now-btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
    color: white !important;
    box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
  }

  .shop-now-btn:hover {
    background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%) !important;
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
  }

  /* Popup variant selector styles */
  .popup-variant-selector {
    margin-bottom: 20px;
  }

  .popup-variant-selector label {
    display: block;
    font-size: 1rem;
    font-weight: 600;
    color: #1d1d1f;
    margin-bottom: 8px;
  }

  .popup-variant-selector select {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid #e9ecef;
    border-radius: 12px;
    font-size: 1rem;
    background: white;
    cursor: pointer;
    transition: border-color 0.3s ease;
  }

  .popup-variant-selector select:focus {
    outline: none;
    border-color: #0071ce;
  }

@media (max-width: 480px) {
    .add-to-cart-popup {
      max-width: 95%;
      margin: 0px;
      border-radius: 16px;
    }

    .popup-header {
      padding: 16px 20px 0 20px;
    }

    .popup-content {
      padding: 0 20px 20px 20px;
    }

    .popup-product-title {
      font-size: 16px;
    }

    .popup-product-price {
      font-size: 18px;
    }

    .cart-notification {
      top: 10px;
      right: 10px;
      left: 10px;
      max-width: none;
    }

    .checkout-buttons {
      flex-direction: column;
    }

    .related-products-grid {
      grid-template-columns: repeat(2, 1fr);
      max-height: 300px;
    }

    .popup-savings-details {
      gap: ```python
6px;
    }

    .popup-savings-text {
      font-size: 11px;
    }

    .popup-savings-price {
      font-size: 9px;
    }

    .popup-validation-content {
      width: 95%;
      margin: 20px;
    }

    .popup-validation-footer {
      flex-direction: column;
    }

    .validation-btn {
      width: 100%;
    }

    .popup-add-to-cart.sticky-active {
      bottom: 100px;
    }

    .popup-checkout-section.sticky-active {
      bottom: 0;
    }

    .product-actions {
      flex-direction: column;
      gap: 8px;
    }

    .quantity-controls {
      justify-content: center;
    }
  }
</style>

<div class="modern-sale-container">
  <div class="sale-header">
    <div class="hero-left">
      <div class="sale-badge">LABOR DAY SALE</div>
      <h1>Our <span class="gradient-text">Biggest Labor Day Sale!</span></h1>
      <div class="discount">FLAT 20% OFF</div>
      <div class="sale-subtitle">
        Celebrate American Labor with EZBioÂ® â€“ Premium Lab Equipment at 20% Off!
      </div>
      <a href="#products-section" class="shop-now-cta" onclick="scrollToProducts()">Shop Now & Save Big!</a>
    </div>

    <div class="hero-right">
      <div class="header-timer">
        <div class="header-timer-label">SALE ENDS SEPTEMBER 30TH</div>
        <div class="header-countdown">
          <div class="header-countdown-unit">
            <span id="days">02</span>
            <label>Days</label>
          </div>
          <div class="header-countdown-unit">
            <span id="hours">06</span>
            <label>Hours</label>
          </div>
          <div class="header-countdown-unit">
            <span id="minutes">25</span>
            <label>Mins</label>
          </div>
          <div class="header-countdown-unit">
            <span id="seconds">41</span>
            <label>Secs</label>
          </div>
        </div>
      </div>
    </div>
  </div>



  <div class="tabs-container" id="products-section">

      <!-- Bioprocess Products -->

      <!-- EZBioÂ® Centrifuge Tube Assemblies - 20% Off -->
      {% assign ezbio_centrifuge_tube_assemblies_collection = collections['bioprocess-components-20-off-labor-day-sale-25'] %}
      {% if ezbio_centrifuge_tube_assemblies_collection.products.size > 0 %}
      <div class="collection-section" id="EZBio-Centrifuge-Tube-Assemblies">
        <div class="collection-header">
          <div class="collection-header-content">
            <h2 class="collection-title">
              <a href="#EZBio-Centrifuge-Tube-Assemblies" class="collection-anchor" onclick="copyCollectionURL(event, 'Bioprocess Components - 20% Off Labor Day Sale 25', 'Bioprocess Components - 20% Off Labor Day Sale 25')">Bioprocess Components - 20% Off Labor Day Sale 25</a>
            </h2>
          </div>
        </div>
        <div class="products-grid">
          {% for product in ezbio_centrifuge_tube_assemblies_collection.products %}
          <div class="product-card">
            <div class="discount-badge">
              <div class="discount-label">20% OFF</div>
            </div>
            <div class="product-image">
              {% if product.featured_image %}
                <img src="{{ product.featured_image | img_url: '300x300' }}" alt="{{ product.title }}">
              {% else %}
                <div style="color: #6c757d; font-size: 1rem; text-align: center;">Product Image</div>
              {% endif %}
            </div>
            <div class="product-content">
              <h3 class="product-title">
                <a href="{{ product.url }}" target="_blank" class="product-title-link">{{ product.title }}</a>
              </h3>
              {% if product.variants.first.sku != blank %}
                <div class="product-sku" onclick="copyToClipboard('{{ product.variants.first.sku }}', event)">
                  {{ product.variants.first.sku }}
                  <svg class="copy-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                    <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"></path>
                  </svg>
                </div>
              {% endif %}
              <div class="product-price">
                {% if product.compare_at_price > product.price %}
                  <span class="original-price">${{ product.compare_at_price | money_without_currency }}</span>
                {% endif %}
                <span class="sale-price">${{ product.price | money_without_currency }}</span>
                <span class="final-price" data-sale-price="{{ product.price | money_without_currency }}" data-discount="15"></span>
              </div>

              <!-- Product Variants and Quantity Container -->
              <div class="product-variants-quantity-container">
              <!-- Product Variants -->
              {% if product.variants.size > 1 %}
                <div class="product-variants">
                  <label for="variant-{{ product.id }}">Select Variant:</label>
                  <select class="variant-selector" id="variant-{{ product.id }}" data-product-id="{{ product.id }}" onchange="updateVariantPrice(this, {{ product.price }})">
                    {% for variant in product.variants %}
                      {% assign discounted_price = variant.price | times: 0.75 %}
                      <option value="{{ variant.id }}" data-price="{{ variant.price }}" data-sku="{{ variant.sku }}">{{ variant.title }} - ${{ discounted_price | money_without_currency }}</option>
                    {% endfor %}
                  </select>
                </div>
              {% endif %}

              <!-- Product Quantity -->
              <div class="product-quantity">
                <label for="quantity-{{ product.id }}">Quantity:</label>
                <div class="quantity-controls">
                  {% comment %} <button onclick="decreaseQuantity({{ product.id }})">-</button> {% endcomment %}
                  <input type="number" id="quantity-{{ product.id }}" class="quantity-input" value="1" min="1">
                  {% comment %} <button onclick="increaseQuantity({{ product.id }})">+</button> {% endcomment %}
                </div>
              </div>

              </div>
              <!-- Product Actions -->
              <div class="product-actions">
                <button class="product-cta add-to-cart-btn" onclick="addToCartDirectly(event, {{ product.id }}, '{{ product.title | escape }}', '{{ product.featured_image | img_url: '300x300' }}', '{{ product.variants.first.sku }}', {{ product.price }}, {{ product.variants.first.id }}, {{ product.compare_at_price | default: 0 }})">Add to Cart</button>
                <button class="product-cta shop-now-btn" onclick="openAddToCartPopupWithEvent(event, {{ product.id }}, '{{ product.title | escape }}', '{{ product.featured_image | img_url: '300x300' }}', '{{ product.variants.first.sku }}', {{ product.price }}, {{ product.variants.first.id }}, {{ product.compare_at_price | default: 0 }})">Shop Now</button>
              </div>

            </div>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      <!-- EZBioÂ® MTO Centrifuge Tube Assemblies - 25% Off -->
      {% assign ezbio_mto_centrifuge_tube_assemblies_collection = collections['bottles-20-off-labor-day-sale-25'] %}
      {% if ezbio_mto_centrifuge_tube_assemblies_collection.products.size > 0 %}
      <div class="collection-section" id="EZBio-MTO-Centrifuge-Tube-Assemblies">
        <div class="collection-header">
          <div class="collection-header-content">
            <h2 class="collection-title">
              <a href="#EZBio-MTO-Centrifuge-Tube-Assemblies" class="collection-anchor" onclick="copyCollectionURL(event, 'Bottles - 20% Off Labor Day Sale 25', 'Bottles - 20% Off Labor Day Sale 25')">Bottles - 20% Off Labor Day Sale 25</a>
            </h2>
          </div>
        </div>
        <div class="products-grid">
          {% for product in ezbio_mto_centrifuge_tube_assemblies_collection.products %}
          <div class="product-card">
            <div class="discount-badge">
              <div class="discount-label">20% OFF</div>
            </div>
            <div class="product-image">
              {% if product.featured_image %}
                <img src="{{ product.featured_image | img_url: '300x300' }}" alt="{{ product.title }}">
              {% else %}
                <div style="color: #6c757d; font-size: 1rem; text-align: center;">Product Image</div>
              {% endif %}
            </div>
            <div class="product-content">
              <h3 class="product-title">
                <a href="{{ product.url }}" target="_blank" class="product-title-link">{{ product.title }}</a>
              </h3>
              {% if product.variants.first.sku != blank %}
                <div class="product-sku" onclick="copyToClipboard('{{ product.variants.first.sku }}', event)">
                  {{ product.variants.first.sku }}
                  <svg class="copy-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                    <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"></path>
                  </svg>
                </div>
              {% endif %}
              <div class="product-price">
                {% if product.compare_at_price > product.price %}
                  <span class="original-price">${{ product.compare_at_price | money_without_currency }}</span>
                {% endif %}
                <span class="sale-price">${{ product.price | money_without_currency }}</span>
                <span class="final-price" data-sale-price="{{ product.price | money_without_currency }}" data-discount="15"></span>
              </div>

              <!-- Product Variants and Quantity Container -->              <div class="product-variants-quantity-container">
              <!-- Product Variants -->
              {% if product.variants.size > 1 %}
                <div class="product-variants">
                  <label for="variant-{{ product.id }}">Select Variant:</label>
                  <select class="variant-selector" id="variant-{{ product.id }}" data-product-id="{{ product.id }}" onchange="updateVariantPrice(this, {{ product.price }})">
                    {% for variant in product.variants %}
                      {% assign discounted_price = variant.price | times: 0.75 %}
                      <option value="{{ variant.id }}" data-price="{{ variant.price }}" data-sku="{{ variant.sku }}">{{ variant.title }} - ${{ discounted_price | money_without_currency }}</option>
                    {% endfor %}
                  </select>
                </div>
              {% endif %}

              <!-- Product Quantity -->
              <div class="product-quantity">
                <label for="quantity-{{ product.id }}">Quantity:</label>
                <div class="quantity-controls">
                  {% comment %} <button onclick="decreaseQuantity({{ product.id }})">-</button> {% endcomment %}
                  <input type="number" id="quantity-{{ product.id }}" class="quantity-input" value="1" min="1">
                  {% comment %} <button onclick="increaseQuantity({{ product.id }})">+</button> {% endcomment %}
                </div>
              </div>

              </div>
              <!-- Product Actions -->
              <div class="product-actions">
                <button class="product-cta add-to-cart-btn" onclick="addToCartDirectly(event, {{ product.id }}, '{{ product.title | escape }}', '{{ product.featured_image | img_url: '300x300' }}', '{{ product.variants.first.sku }}', {{ product.price }}, {{ product.variants.first.id }}, {{ product.compare_at_price | default: 0 }})">Add to Cart</button>
                <button class="product-cta shop-now-btn" onclick="openAddToCartPopupWithEvent(event, {{ product.id }}, '{{ product.title | escape }}', '{{ product.featured_image | img_url: '300x300' }}', '{{ product.variants.first.sku }}', {{ product.price }}, {{ product.variants.first.id }}, {{ product.compare_at_price | default: 0 }})">Shop Now</button>
              </div>

            </div>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      <!-- EZBioÂ® VacTrap-S - 25% Off -->
      {% assign ezbio_vactrap_s_collection = collections['carboys-20-off-labor-day-sale-25'] %}
      {% if ezbio_vactrap_s_collection.products.size > 0 %}
      <div class="collection-section" id="EZBio-VacTrap-S">
        <div class="collection-header">
          <div class="collection-header-content">
            <h2 class="collection-title">
              <a href="#EZBio-VacTrap-S" class="collection-anchor" onclick="copyCollectionURL(event, 'Carboys Sale', 'Carboys Sale')">Carboys - 20% Off Labor Day Sale 25</a>
            </h2>
          </div>
        </div>
        <div class="products-grid">
          {% for product in ezbio_vactrap_s_collection.products %}
          <div class="product-card">
            <div class="discount-badge">
              <div class="discount-label">20% OFF</div>
            </div>
            <div class="product-image">
              {% if product.featured_image %}
                <img src="{{ product.featured_image | img_url: '300x300' }}" alt="{{ product.title }}">
              {% else %}
                <div style="color: #6c757d; font-size: 1rem; text-align: center;">Product Image</div>
              {% endif %}
            </div>
            <div class="product-content">
              <h3 class="product-title">
                <a href="{{ product.url }}" target="_blank" class="product-title-link">{{ product.title }}</a>
              </h3>
              {% if product.variants.first.sku != blank %}
                <div class="product-sku" onclick="copyToClipboard('{{ product.variants.first.sku }}', event)">
                  {{ product.variants.first.sku }}
                  <svg class="copy-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                    <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"></path>
                  </svg>
                </div>
              {% endif %}
              <div class="product-price">
                {% if product.compare_at_price > product.price %}
                  <span class="original-price">${{ product.compare_at_price | money_without_currency }}</span>
                {% endif %}
                <span class="sale-price">${{ product.price | money_without_currency }}</span>
                <span class="final-price" data-sale-price="{{ product.price | money_without_currency }}" data-discount="15"></span>
              </div>

              <!-- Product Variants and Quantity Container -->
              <div class="product-variants-quantity-container">
              <!-- Product Variants -->
              {% if product.variants.size > 1 %}
                <div class="product-variants">
                  <label for="variant-{{ product.id }}">Select Variant:</label>
                  <select class="variant-selector" id="variant-{{ product.id }}" data-product-id="{{ product.id }}" onchange="updateVariantPrice(this, {{ product.price }})">
                    {% for variant in product.variants %}
                      {% assign discounted_price = variant.price | times: 0.75 %}
                      <option value="{{ variant.id }}" data-price="{{ variant.price }}" data-sku="{{ variant.sku }}">{{ variant.title }} - ${{ discounted_price | money_without_currency }}</option>
                    {% endfor %}
                  </select>
                </div>
              {% endif %}

              <!-- Product Quantity -->
              <div class="product-quantity">
                <label for="quantity-{{ product.id }}">Quantity:</label>
                <div class="quantity-controls">
                  <input type="number" id="quantity-{{ product.id }}" class="quantity-input" value="1" min="1">
                </div>
              </div>
              </div>

              <!-- Product Actions -->
              <div class="product-actions">
                <button class="product-cta add-to-cart-btn" onclick="addToCartDirectly(event, {{ product.id }}, '{{ product.title | escape }}', '{{ product.featured_image | img_url: '300x300' }}', '{{ product.variants.first.sku }}', {{ product.price }}, {{ product.variants.first.id }}, {{ product.compare_at_price | default: 0 }})">Add to Cart</button>
                <button class="product-cta shop-now-btn" onclick="openAddToCartPopupWithEvent(event, {{ product.id }}, '{{ product.title | escape }}', '{{ product.featured_image | img_url: '300x300' }}', '{{ product.variants.first.sku }}', {{ product.price }}, {{ product.variants.first.id }}, {{ product.compare_at_price | default: 0 }})">Shop Now</button>
              </div>

            </div>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}

    </div>
</div>

<div id="addToCartPopup" class="add-to-cart-popup">
    <div class="popup-header">
        <div></div>
        <div class="popup-discount-badge" id="popupDiscountBadge"></div>
        <button class="popup-close" onclick="closeAddToCartPopup()">Ã—</button>
    </div>

    <div class="popup-content">
        <div class="popup-left-section">
            <div class="popup-product-image">
                <img id="popupProductImage" src="" alt="Product Image">
            </div>
            <div class="left-related-products-section" id="leftRelatedProducts" style="display: none;">
                <h3>ðŸ’¡ You might also like</h3>
                <div class="left-related-products-grid" id="leftRelatedProductsGrid">
                </div>
            </div>
        </div>

        <div class="popup-right-section">
            <h2 class="popup-product-title" id="popupProductTitle"></h2>
            <div class="popup-product-sku">SKU: <span id="popupProductSKU"></span></div>

            <div class="popup-product-price">
                 {% comment %} Add the original price in popup {% endcomment %}
                <span class="popup-original-price" id="popupOriginalPrice" style="display: none;">$0.00</span>
                <span class="popup-sale-price">${{ product.price | money_without_currency }}<span id="popupSalePrice"></span></span>

                {% comment %} Add strikethrough to sale price and decrease font size in popup {% endcomment %}

                <span class="popup-final-price" id="popupFinalPrice">$0.00</span>
            </div>

            <!-- Add variant selector to popup -->
           <div class="product-variants-quantity-container">
             <div class="popup-variant-selector" id="popupVariantSelector">
                <label for="popup-variant-select">Select Variant:</label>
                <select id="popup-variant-select" onchange="updatePopupVariant(this)">
                </select>
            </div>
           <div class="popup-quantity-section">
            <label class="popup-quantity-label">Quantity</label>
            <div class="popup-quantity-controls">
                {% comment %} <button class="popup-quantity-btn" onclick="decreaseQuantity()" type="button">âˆ’</button> {% endcomment %}
                <input type="number" class="popup-quantity-input" id="popupQuantity" value="1" min="1" readonly>
                {% comment %} <button class="popup-quantity-btn" onclick="increaseQuantity()" type="button">+</button> {% endcomment %}
            </div>
          </div>
           </div>

        <div class="popup-smart-savings">
            <div class="popup-smart-savings-header">
                <div style="display: flex; align-items: center;">
                    <img src="https://cdn.shopify.com/s/files/1/1064/0118/files/New_Icon.f3cc687da18d1b9a7778597a17d03fcc.gif?v=1712245731" alt="Smart Savings" style="height: 16px; width: 16px; margin-right: 4px;">
                    Smart Savings
                </div>
            </div>
            <div class="popup-savings-preview">Buy 2 items and save $<span class="popup-savings-preview-amount" id="popupSavingsPreview">0.00</span>/item</div>
            <div class="popup-savings-details" style="display: flex;">
                <div class="popup-savings-option popup-savings-2" onclick="selectSavingsOption(2)">
                    <div class="popup-savings-label">MOST POPULAR</div>
                    <div class="popup-savings-text">More than 2 Items</div>
                    <div class="popup-savings-price">and save $<span class="popup-savings-amount" id="popupSavingsAmount2">0.00</span>/item</div>
                </div>
                <div class="popup-savings-option popup-savings-3" onclick="selectSavingsOption(3)">
                    <div class="popup-savings-label">BEST VALUE</div>
                    <div class="popup-savings-text">More than 3 Items</div>
                    <div class="popup-savings-price">and save $<span class="popup-savings-amount" id="popupSavingsAmount3">0.00</span>/item</div>
                </div>
                <div class="popup-savings-option popup-savings-5" onclick="selectSavingsOption(5)">
                    <div class="popup-savings-label">MOST SAVINGS</div>
                    <div class="popup-savings-text">More than 5 Items</div>
                    <div class="popup-savings-price">and save $<span class="popup-savings-amount" id="popupSavingsAmount5">0.00</span>/item</div>
                </div>
            </div>
        </div>


        <button class="popup-add-to-cart" onclick="addToCart()">Add to Cart</button>
        </div>
    </div>
</div>

<div id="overlay" class="overlay" onclick="closeAddToCartPopup()"></div>

<script>

// Countdown Timer
// Helper function to get product handle from product ID
function getProductHandleFromId(productId) {
    // Try to find the product handle from the product cards
    const productCards = document.querySelectorAll('.product-card');
    for (const card of productCards) {
        const shopButton = card.querySelector('.shop-now-btn');
        if (shopButton) {
            const onclickAttr = shopButton.getAttribute('onclick');
            if (onclickAttr && onclickAttr.includes(productId)) {
                // Extract product handle from the card or page context
                // This is a fallback method - you might need to adjust based on your data structure
                return null; // Return null to skip fetch if we can't determine handle
            }
        }
    }
    return null;
}

// Global function for opening popup with event handling
function openAddToCartPopupWithEvent(event, productId, productTitle, productImage, productSKU, productPrice, productVariantId, compareAtPrice) {
    event.stopPropagation();

    // Get the current selected variant from the card
    const productCard = event.target.closest('.product-card');
    if (productCard) {
        const variantSelector = productCard.querySelector('.variant-selector');
        if (variantSelector && variantSelector.selectedIndex >= 0) {
            const selectedOption = variantSelector.options[variantSelector.selectedIndex];
            const currentVariantId = selectedOption.value;
            const currentSKU = selectedOption.dataset.sku;
            const currentPrice = selectedOption.dataset.price;

            // Use the currently selected variant data instead of default
            // Price is now in cents format from Shopify
            const priceInCents = parseInt(currentPrice);
            openAddToCartPopup(productId, productTitle, productImage, currentSKU, priceInCents, currentVariantId, compareAtPrice, event);
        } else {
            // Fallback to original data if no variant selector
            openAddToCartPopup(productId, productTitle, productImage, productSKU, productPrice, productVariantId, compareAtPrice, event);
        }
    } else {
        openAddToCartPopup(productId, productTitle, productImage, productSKU, productPrice, productVariantId, compareAtPrice, event);
    }
}

function updateCountdown() {
  // Set the date we're counting down to (September 30th, 2025 at 11:59 PM)
  const countDownDate = new Date('2025-09-30T23:59:59').getTime();

  const timer = setInterval(function() {
    const now = new Date().getTime();
    const distance = countDownDate - now;

    const days = Math.floor(distance / (1000 * 60 * 60 * 24));
    const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((distance % (1000 * 60)) / 1000);

    const dayStr = String(days).padStart(2, '0');
    const hourStr = String(hours).padStart(2, '0');
    const minuteStr = String(minutes).padStart(2, '0');
    const secondStr = String(seconds).padStart(2, '0');

    // Update main timer
    const daysEl = document.getElementById("days");
    const hoursEl = document.getElementById("hours");
    const minutesEl = document.getElementById("minutes");
    const secondsEl = document.getElementById("seconds");

    if (daysEl) daysEl.innerHTML = dayStr;
    if (hoursEl) hoursEl.innerHTML = hourStr;
    if (minutesEl) minutesEl.innerHTML = minuteStr;
    if (secondsEl) secondsEl.innerHTML = secondStr;

    // Update sticky timer
    const stickyDaysEl = document.getElementById("sticky-days");
    const stickyHoursEl = document.getElementById("sticky-hours");
    const stickyMinutesEl = document.getElementById("sticky-minutes");
    const stickySecondsEl = document.getElementById("sticky-seconds");

    if (stickyDaysEl) stickyDaysEl.innerHTML = dayStr;
    if (stickyHoursEl) stickyHoursEl.innerHTML = hourStr;
    if (stickyMinutesEl) stickyMinutesEl.innerHTML = minuteStr;
    if (stickySecondsEl) stickySecondsEl.innerHTML = secondStr;

    if (distance < 0) {
      clearInterval(timer);
      // Reset both timers
      ["days", "hours", "minutes", "seconds", "sticky-days", "sticky-hours", "sticky-minutes", "sticky-seconds"].forEach(id => {
        const element = document.getElementById(id);
        if (element) element.innerHTML = "00";
      });
    }
  }, 1000);
}

// Scroll to products function
function scrollToProducts() {
  const productsSection = document.getElementById('products-section');
  if (productsSection) {
    productsSection.scrollIntoView({
      behavior: 'smooth',
      block: 'start'
    });
  }
}

// Calculate final prices and smart savings
function calculatePricesAndSavings() {
  // Calculate final prices based on discount percentage from the actual discount label
  const finalPrices = document.querySelectorAll('.final-price');
  finalPrices.forEach(finalPrice => {
    const salePrice = parseFloat(finalPrice.dataset.salePrice.replace(/,/g, ''));

    // Get the actual discount percentage from the discount label in the same product card
    const productCard = finalPrice.closest('.product-card');
    const discountLabel = productCard.querySelector('.discount-label');
    const discountText = discountLabel.textContent;
    const actualDiscountPercentage = parseInt(discountText.replace(/[^\d]/g, ''));

    const finalPriceAmount = salePrice - (salePrice * actualDiscountPercentage / 100);

    // Format price consistently with 2 decimal places
    finalPrice.textContent = '$' + finalPriceAmount.toFixed(2);
  });

  // Calculate smart savings amounts for expanded sections
  const savingsAmounts = document.querySelectorAll('.savings-amount');
  savingsAmounts.forEach(savingsAmount => {
    const basePrice = parseFloat(savingsAmount.dataset.basePrice.replace(/,/g, ''));
    const qty = parseInt(savingsAmount.dataset.qty);

    // Find the discount percentage from the product card's discount badge
    const productCard = savingsAmount.closest('.product-card');
    const discountLabel = productCard.querySelector('.discount-label');
    const discountText = discountLabel.textContent;
    const discountPercentage = parseInt(discountText.replace(/[^\d]/g, ''));
    const discountRate = discountPercentage / 100;

    const regularTotal = basePrice * qty;
    const discountedTotal = regularTotal * (1 - discountRate);
    const totalSavings = regularTotal - discountedTotal;
    const perItemSavings = totalSavings / qty;

    savingsAmount.textContent = perItemSavings.toFixed(2);
  });

  // Calculate smart savings preview amounts - must match the savings amounts
  const savingsPreviewAmounts = document.querySelectorAll('.savings-preview-amount');
  savingsPreviewAmounts.forEach(savingsPreviewAmount => {
    const basePrice = parseFloat(savingsPreviewAmount.dataset.basePrice.replace(/,/g, ''));
    const qty = parseInt(savingsPreviewAmount.dataset.qty);

    // Find the discount percentage from the product card's discount badge
    const productCard = savingsPreviewAmount.closest('.product-card');
    const discountLabel = productCard.querySelector('.discount-label');
    const discountText = discountLabel.textContent;
    const discountPercentage = parseInt(discountText.replace(/[^\d]/g, ''));
    const discountRate = discountPercentage / 100;

    const regularTotal = basePrice * qty;
    const discountedTotal = regularTotal * (1 - discountRate);
    const totalSavings = regularTotal - discountedTotal;
    const perItemSavings = totalSavings / qty;

    savingsPreviewAmount.textContent = perItemSavings.toFixed(2);
  });
}

function toggleSavings(event, element) {
  // Prevent navigation to product page
  event.stopPropagation();
  element.classList.toggle('expanded');
}
 function copyToClipboard(text, event) {
    event.stopPropagation();
    navigator.clipboard.writeText(text)
        .then(() => {
            // Show toast notification
            const toast = document.createElement('div');
            toast.classList.add('toast');
            toast.textContent = text + ' SKU copied!';
            document.body.appendChild(toast);
            // Animate toast
            setTimeout(() => {
                toast.classList.add('show');
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => {
                        if (document.body.contains(toast)) {
                            document.body.removeChild(toast);
                        }
                    }, 300); // Duration of fade-out
                }, 2000); // Display duration
            }, 100); // Small delay before fade-in
        })
        .catch(err => {
            console.error('Could not copy text: ', err);
            // Fallback toast for error
            const errorToast = document.createElement('div');
            errorToast.classList.add('toast');
            errorToast.textContent = 'Failed to copy SKU. Please try again.';
            errorToast.style.background = '#dc3545';
            document.body.appendChild(errorToast);
            setTimeout(() => {
                errorToast.classList.add('show');
                setTimeout(() => {
                    errorToast.classList.remove('show');
                    setTimeout(() => {
                        if (document.body.contains(errorToast)) {
                            document.body.removeChild(errorToast);
                        }
                    }, 300);
                }, 2000);
            }, 100);
        });
}

function increaseQuantity(productId) {
  const quantityInput = document.getElementById(`quantity-${productId}`);
  let currentValue = parseInt(quantityInput.value);
  quantityInput.value = currentValue + 1;
}

function decreaseQuantity(productId) {
  const quantityInput = document.getElementById(`quantity-${productId}`);
  let currentValue = parseInt(quantityInput.value);
  if (currentValue > 1) {
    quantityInput.value = currentValue - 1;
  }
}

// Function to update variant price based on selected variant
function updateVariantPrice(selectElement, basePrice) {
    const productId = selectElement.dataset.productId;
    const selectedVariantId = selectElement.value;
    const selectedVariantPrice = selectElement.options[selectElement.selectedIndex].dataset.price;
    const selectedVariantSku = selectElement.options[selectElement.selectedIndex].dataset.sku;

    // Update the price display in the product card (if needed)
    const productCard = selectElement.closest('.product-card');
    const finalPriceElement = productCard.querySelector('.final-price');

    if (finalPriceElement) {
        const discountLabel = productCard.querySelector('.discount-label');
        const discountText = discountLabel.textContent;
        const actualDiscountPercentage = parseInt(discountText.replace(/[^\d]/g, ''));
        const salePriceInCents = parseInt(selectedVariantPrice);
        const salePriceInDollars = salePriceInCents / 100;

        const finalPriceAmount = salePriceInDollars - (salePriceInDollars * actualDiscountPercentage / 100);
        finalPriceElement.textContent = '$' + finalPriceAmount.toFixed(2);
        finalPriceElement.dataset.salePrice = salePriceInDollars.toFixed(2);
    }

    // Update the SKU display
    const skuElement = productCard.querySelector('.product-sku');
    if (skuElement && selectedVariantSku) {
        // Update the displayed SKU text (keep the copy icon)
        const skuTextNode = skuElement.firstChild;
        if (skuTextNode && skuTextNode.nodeType === 3) { // Text node
            skuTextNode.textContent = selectedVariantSku + ' ';
        } else {
            // If no text node exists, create one
            skuElement.innerHTML = selectedVariantSku + ' ' + skuElement.innerHTML.substring(skuElement.innerHTML.indexOf('<svg'));
        }

        // Update the onclick attribute for copying
        skuElement.setAttribute('onclick', `copyToClipboard('${selectedVariantSku}', event)`);
    }
}

// Add to cart functionality with popup
let selectedProductId;
let selectedProductTitle;
let selectedProductImage;
let selectedProductSKU;
let selectedProductPrice;
let selectedProductVariantId;
let selectedProductCompareAtPrice;
let selectedProductDiscount;

function openAddToCartPopup(productId, productTitle, productImage, productSKU, productPrice, productVariantId, compareAtPrice, event) {
    selectedProductId = productId;
    selectedProductTitle = productTitle;
    selectedProductImage = productImage;
    selectedProductSKU = productSKU;
    selectedProductPrice = productPrice;
    selectedProductVariantId = productVariantId;
    selectedProductCompareAtPrice = compareAtPrice;

    // Find the product card to get discount information by using the event target
    const productCard = event.target.closest('.product-card');
    let discountPercentage = 0;
    let finalPrice = productPrice;

    if (productCard) {
        const discountLabel = productCard.querySelector('.discount-label');
        if (discountLabel) {
            const discountText = discountLabel.textContent;
            discountPercentage = parseInt(discountText.replace(/[^\d]/g, '')) || 0;

            // Calculate final price properly
            if (discountPercentage > 0) {
                finalPrice = productPrice * (1 - discountPercentage / 100);
            }
        }
    }

    selectedProductDiscount = discountPercentage;

    // Helper function to format price
    function formatPrice(price) {
        const priceInNumber = Number(price);
        // Always show 2 decimal places for consistency
        return priceInNumber.toFixed(2);
    }

    // Populate popup content
    const popupImageEl = document.getElementById('popupProductImage');
    const popupTitleEl = document.getElementById('popupProductTitle');
    const popupSKUEl = document.getElementById('popupProductSKU');

    if (popupImageEl) popupImageEl.src = productImage;
    if (popupTitleEl) popupTitleEl.textContent = productTitle;
    if (popupSKUEl) popupSKUEl.textContent = productSKU;

    // Add the original price to the popup
    const originalPriceElement = document.getElementById('popupOriginalPrice');
    if (selectedProductCompareAtPrice > 0){
        originalPriceElement.textContent = '$' + formatPrice(selectedProductCompareAtPrice / 100); // original price
        originalPriceElement.style.display = 'inline';
    }else {
        originalPriceElement.style.display = 'none';
    }

    const popupSalePriceEl = document.getElementById('popupSalePrice');
    const popupFinalPriceEl = document.getElementById('popupFinalPrice');
    const popupQuantityEl = document.getElementById('popupQuantity');

    if (popupSalePriceEl) popupSalePriceEl.textContent = formatPrice(productPrice / 100);
    if (popupFinalPriceEl) popupFinalPriceEl.textContent = '$' + formatPrice(finalPrice / 100);
    if (popupQuantityEl) popupQuantityEl.value = 1;

    // Show discount badge with the SAME percentage as the product card
    const discountBadge = document.getElementById('popupDiscountBadge');
    if (discountPercentage > 0) {
        discountBadge.textContent = discountPercentage + '% OFF';
        discountBadge.style.display = 'block';
    } else {
        discountBadge.style.display = 'none';
    }

  // Calculate smart savings for different quantities using the SAME logic as product cards
  const priceInDollars = productPrice / 100;

  // Calculate for 2+ items
  const qty2 = 2;
  const regularTotal2 = priceInDollars * qty2;
  const discountedTotal2 = regularTotal2 * (1 - discountPercentage / 100);
  const totalSavings2 = regularTotal2 - discountedTotal2;
  const perItemSavings2 = totalSavings2 / qty2;

  // Calculate for 3+ items - FIXED: Use correct quantity multiplier
  const qty3 = 3;
  const bulkDiscount3 = discountPercentage + 5; // Additional 5% bulk discount for 3+ items
  const regularTotal3 = priceInDollars * qty3;
  const discountedTotal3 = regularTotal3 * (1 - bulkDiscount3 / 100);
  const totalSavings3 = regularTotal3 - discountedTotal3;
  const perItemSavings3 = totalSavings3 / qty3;

  // Calculate for 5+ items - FIXED: Use correct quantity multiplier
  const qty5 = 5;
  const bulkDiscount5 = discountPercentage + 10; // Additional 10% bulk discount for 5+ items
  const regularTotal5 = priceInDollars * qty5;
  const discountedTotal5 = regularTotal5 * (1 - bulkDiscount5 / 100);
  const totalSavings5 = regularTotal5 - discountedTotal5;
  const perItemSavings5 = totalSavings5 / qty5;

    const popupSavingsPreviewEl = document.getElementById('popupSavingsPreview');
    const popupSavingsAmount2El = document.getElementById('popupSavingsAmount2');
    const popupSavingsAmount3El = document.getElementById('popupSavingsAmount3');
    const popupSavingsAmount5El = document.getElementById('popupSavingsAmount5');

    if (popupSavingsPreviewEl) popupSavingsPreviewEl.textContent = formatPrice(perItemSavings2);
    if (popupSavingsAmount2El) popupSavingsAmount2El.textContent = formatPrice(perItemSavings2);
    if (popupSavingsAmount3El) popupSavingsAmount3El.textContent = formatPrice(perItemSavings3);
    if (popupSavingsAmount5El) popupSavingsAmount5El.textContent = formatPrice(perItemSavings5);

    // Reset savings selections
    document.querySelectorAll('.popup-savings-option').forEach(option => {
        option.classList.remove('selected');
    });

    // Populate variant selector in the popup
    const variantSelect = document.getElementById('popup-variant-select');
    const variantSelectorContainer = document.getElementById('popupVariantSelector');

    if (variantSelect && variantSelectorContainer) {
        variantSelect.innerHTML = '';  // Clear existing options

        // Find the product card to get variant information directly from the DOM
        const productCards = document.querySelectorAll('.product-card');
        let matchingProductCard = null;

        // Find the matching product card by checking the onclick attributes or SKU
        for (const card of productCards) {
            const cardSku = card.querySelector('.product-sku')?.textContent.trim();
            if (cardSku === selectedProductSKU) {
                matchingProductCard = card;
                break;
            }
        }

        if (matchingProductCard) {
            const cardVariantSelect = matchingProductCard.querySelector('.variant-selector');

            if (cardVariantSelect && cardVariantSelect.options.length > 1) {
                // Show variant selector if multiple variants exist
                variantSelectorContainer.style.display = 'block';

                // Copy all options from the card's variant selector
                Array.from(cardVariantSelect.options).forEach(cardOption => {
                    const option = document.createElement('option');
                    option.value = cardOption.value;
                    option.text = cardOption.text;
                    option.dataset.price = cardOption.dataset.price;
                    option.dataset.sku = cardOption.dataset.sku;
                    option.dataset.discountedPrice = cardOption.dataset.discountedPrice;
                    variantSelect.appendChild(option);
                });

                // Set selected variant to match what was passed from the card
                variantSelect.value = selectedProductVariantId;

                // Update selectedProductVariantId when variant changes
                variantSelect.addEventListener('change', function() {
                    selectedProductVariantId = this.value;
                    updatePopupVariant(this);
                });
            } else {
                // Hide variant selector if only one variant
                variantSelectorContainer.style.display = 'none';
            }
        } else {
            // Fallback: try the original fetch method with product handle
            const productHandle = getProductHandleFromId(productId);
            if (productHandle) {
                fetch(`/products/${productHandle}.js`)
                .then(response => response.json())
                .then(product => {
                    if (product.variants && product.variants.length > 1) {
                        variantSelectorContainer.style.display = 'block';

                        product.variants.forEach(variant => {
                            const option = document.createElement('option');
                            option.value = variant.id;
                            option.text = variant.title;
                            option.dataset.price = variant.price;
                            variantSelect.appendChild(option);
                        });

                        variantSelect.value = selectedProductVariantId;
                        variantSelect.addEventListener('change', function() {
                            selectedProductVariantId = this.value;
                            updatePopupVariant(this);
                        });
                    } else {
                        variantSelectorContainer.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Error fetching product details:', error);
                    variantSelectorContainer.style.display = 'none';
                });
            } else {
                variantSelectorContainer.style.display = 'none';
            }
        }
    }

    // Show overlay first
    const overlay = document.getElementById('overlay');
    const popup = document.getElementById('addToCartPopup');

    overlay.classList.add('show');

    // Small delay for smooth animation
    setTimeout(() => {
        popup.classList.add('show');
    }, 10);

    // Prevent body scroll
    document.body.style.overflow = 'hidden';

    // Ensure Add to Cart button is visible
    const addToCartBtn = document.querySelector('.popup-add-to-cart');
    if (addToCartBtn) {
        addToCartBtn.style.display = 'block';
    }

    // Load current cart info first
    updateCartInfo();

    // Show related products in left column on desktop only if cart has items
    setTimeout(() => {
        if (currentCartCount > 0 && window.innerWidth >= 768) {
            updateLeftColumnRelatedProducts();
        }
    }, 500);
}

function closeAddToCartPopup() {
    const overlay = document.getElementById('overlay');
    const popup = document.getElementById('addToCartPopup');

    popup.classList.remove('show');

    setTimeout(() => {
        overlay.classList.remove('show');
        document.body.style.overflow = '';

        // Clean up any dynamically created checkout sections
        const checkoutSection = document.querySelector('.popup-checkout-section');
        if (checkoutSection) {
            checkoutSection.remove();
        }
    }, 300);
}

function increaseQuantity() {
    const quantityInput = document.getElementById('popupQuantity');
    const currentValue = parseInt(quantityInput.value);
    quantityInput.value = currentValue + 1;
}

function decreaseQuantity() {
    const quantityInput = document.getElementById('popupQuantity');
    const currentValue = parseInt(quantityInput.value);
    if (currentValue > 1) {
        quantityInput.value = currentValue - 1;
    }
}

function togglePopupSavings(element) {
    element.classList.toggle('expanded');
}

function selectSavingsOption(quantity) {
    // Remove selected class from all options
    document.querySelectorAll('.popup-savings-option').forEach(option => {
        option.classList.remove('selected');
    });

    // Add selected class to clicked option
    document.querySelector(`.popup-savings-${quantity}`).classList.add('selected');

    // Update quantity input
    document.getElementById('popupQuantity').value = quantity;

    // Don't auto-add to cart - let user click Add to Cart button
    // This gives users more control over their purchase
}

function addToCart() {
    const quantity = document.getElementById('popupQuantity').value;
    const variantSelect = document.getElementById('popup-variant-select');
    let selectedVariantId;

    // Get the selected variant ID from dropdown or use the default one
    if (variantSelect && variantSelect.value) {
        selectedVariantId = variantSelect.value;
    } else {
        selectedVariantId = selectedProductVariantId;
    }

    // Ensure we have a valid variant ID
    if (!selectedVariantId) {
        console.error('No variant ID found');
        showAddToCartError();
        return;
    }

    // Add to cart via AJAX instead of redirect
    fetch('/cart/add.js', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            id: parseInt(selectedVariantId),
            quantity: parseInt(quantity)
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        console.log('Product added to cart from popup:', data);
        // Show success notification
        showAddToCartSuccess();

        // Update header cart count immediately
        updateHeaderCartCount();

        // Check for automatic coupon codes after adding to cart
        setTimeout(() => {
            checkForAutomaticCoupons();
        }, 1000);

        // Update cart count and show checkout section now that cart has items
        updateCartInfo();

        // Reset quantity to 1 after adding
        document.getElementById('popupQuantity').value = 1;

        // Keep the Add to Cart button visible alongside checkout options
        const addToCartBtn = document.querySelector('.popup-add-to-cart');
        if (addToCartBtn) {
            addToCartBtn.style.display = 'block';
        }
    })
    .catch(error => {
        console.error('Error adding to cart:', error);
        showAddToCartError();
    });
}

function addToCartDirectly(event, productId, productTitle, productImage, productSKU, productPrice, productVariantId, compareAtPrice) {
    event.preventDefault();

    const productCard = event.target.closest('.product-card');
    const quantityInput = productCard.querySelector('.quantity-input');
    const quantity = quantityInput ? quantityInput.value : 1;
    const variantSelect = productCard.querySelector('.variant-selector');
    let selectedVariantId;

    if (variantSelect && variantSelect.value) {
        selectedVariantId = variantSelect.value;
    } else {
        selectedVariantId = productVariantId;
    }

    // Ensure we have a valid variant ID
    if (!selectedVariantId) {
        console.error('No variant ID found for product:', productId);
        showAddToCartError();
        return;
    }

    fetch('/cart/add.js', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            id: parseInt(selectedVariantId),
            quantity: parseInt(quantity)
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        console.log('Product added to cart:', data);
        // Show success notification
        showAddToCartSuccess();

        // Update header cart count immediately
        updateHeaderCartCount();

        // Check for automatic coupon codes after adding to cart
        setTimeout(() => {
            checkForAutomaticCoupons();
        }, 1000);

        // Update cart count and show checkout section now that cart has items
        updateCartInfo();

        // Reset quantity to 1 after adding
        if (quantityInput) {
            quantityInput.value = 1;
        }
    })
    .catch(error => {
        console.error('Error adding to cart:', error);
        showAddToCartError();
    });
}

function updatePopupVariant(selectElement) {
    const selectedVariantId = selectElement.value;
    const selectedOption = selectElement.options[selectElement.selectedIndex];
    const newPrice = selectedOption.dataset.price;

    console.log("Selected variant in popup:", selectedVariantId, "Raw Price:", newPrice);

    // Update the selected product variant ID
    selectedProductVariantId = selectedVariantId;

    // Update SKU display
    const newSku = selectedOption.dataset.sku;
    if (newSku) {
        selectedProductSKU = newSku;
        const popupSKUEl = document.getElementById('popupProductSKU');
        if (popupSKUEl) {
            popupSKUEl.textContent = newSku;
        }
    }

    // Update price display if price data is available
    if (newPrice) {
        // Parse the price - check if it's already in dollar format or cents
        const priceValue = parseFloat(newPrice);
        let priceInDollars, priceInCents;

        // If the value is very large (>1000), it's likely in cents
        // If it's reasonable (<1000), it's likely in dollars already
        if (priceValue > 1000) {
            priceInCents = parseInt(newPrice);
            priceInDollars = priceInCents / 100;
        } else {
            priceInDollars = priceValue;
            priceInCents = Math.round(priceValue * 100);
        }

        selectedProductPrice = priceInCents; // Store in cents for consistency

        console.log("Price conversion - Raw:", newPrice, "-> Dollars:", priceInDollars, "Cents:", priceInCents);

        // Update sale price
        const popupSalePriceEl = document.getElementById('popupSalePrice');
        if (popupSalePriceEl) {
            popupSalePriceEl.textContent = priceInDollars.toFixed(2);
        }

        // Calculate and update final price with discount
        const discountPercentage = selectedProductDiscount || 0;
        const finalPrice = priceInDollars * (1 - discountPercentage / 100);

        const popupFinalPriceEl = document.getElementById('popupFinalPrice');
        if (popupFinalPriceEl) {
            popupFinalPriceEl.textContent = '$' + finalPrice.toFixed(2);
        }

        // Update smart savings calculations
        updateSmartSavingsForVariant(priceInDollars, discountPercentage);
    }
}

function updateSmartSavingsForVariant(priceInDollars, discountPercentage) {
    // Calculate for 2+ items
    const qty2 = 2;
    const regularTotal2 = priceInDollars * qty2;
    const discountedTotal2 = regularTotal2 * (1 - discountPercentage / 100);
    const totalSavings2 = regularTotal2 - discountedTotal2;
    const perItemSavings2 = totalSavings2 / qty2;

    // Calculate for 3+ items
    const qty3 = 3;
    const bulkDiscount3 = discountPercentage + 5;
    const regularTotal3 = priceInDollars * qty3;
    const discountedTotal3 = regularTotal3 * (1 - bulkDiscount3 / 100);
    const totalSavings3 = regularTotal3 - discountedTotal3;
    const perItemSavings3 = totalSavings3 / qty3;

    // Calculate for 5+ items
    const qty5 = 5;
    const bulkDiscount5 = discountPercentage + 10;
    const regularTotal5 = priceInDollars * qty5;
    const discountedTotal5 = regularTotal5 * (1 - bulkDiscount5 / 100);
    const totalSavings5 = regularTotal5 - discountedTotal5;
    const perItemSavings5 = totalSavings5 / qty5;

    // Update savings displays
    const popupSavingsPreviewEl = document.getElementById('popupSavingsPreview');
    const popupSavingsAmount2El = document.getElementById('popupSavingsAmount2');
    const popupSavingsAmount3El = document.getElementById('popupSavingsAmount3');
    const popupSavingsAmount5El = document.getElementById('popupSavingsAmount5');

    if (popupSavingsPreviewEl) popupSavingsPreviewEl.textContent = perItemSavings2.toFixed(2);
    if (popupSavingsAmount2El) popupSavingsAmount2El.textContent = perItemSavings2.toFixed(2);
    if (popupSavingsAmount3El) popupSavingsAmount3El.textContent = perItemSavings3.toFixed(2);
    if (popupSavingsAmount5El) popupSavingsAmount5El.textContent = perItemSavings5.toFixed(2);
}

function checkForAutomaticCoupons() {
    // Fetch current cart to check if automatic coupons were applied
    fetch('/cart.js')
    .then(response => response.json())
    .then(cart => {
        // Update current cart total
        currentCartTotal = cart.total_price;
        currentCartCount = cart.item_count;

        // Check if there are any discounts applied
        if (cart.discounts && cart.discounts.length > 0) {
            // Show notification about automatic discount
            showAutomaticCouponNotification(cart.discounts);
        }

        // Update checkout button status
        updateCartInfo();
    })
    .catch(error => {
        console.error('Error checking for automatic coupons:', error);
    });
}

function showAutomaticCouponNotification(discounts) {
    const notification = document.createElement('div');
    notification.classList.add('cart-notification', 'success', 'coupon-notification');

    const discountNames = discounts.map(d => d.title).join(', ');
    const totalSavings = discounts.reduce((sum, d) => sum + (d.amount || 0), 0);

    notification.innerHTML = `
        <div class="notification-content">
            <span class="notification-icon">ðŸŽ‰</span>
            <div class="notification-text">
                <strong>Automatic Discount Applied!</strong><br>
                ${discountNames} - Save $${(totalSavings / 100).toFixed(2)}
            </div>
        </div>
    `;
    document.body.appendChild(notification);

    setTimeout(() => {
        notification.classList.add('show');
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    document.body.removeChild(notification);
                }
            }, 300);
        }, 4000); // Show longer for coupon notifications
    }, 100);
}

function showAddToCartSuccess() {
    // Create and show success notification
    const notification = document.createElement('div');
    notification.classList.add('cart-notification', 'success');
    notification.innerHTML = `
        <div class="notification-content">
            <span class="notification-icon">âœ“</span>
            <span class="notification-text">Product added to cart successfully!</span>
        </div>
    `;
    document.body.appendChild(notification);

    setTimeout(() => {
        notification.classList.add('show');
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    document.body.removeChild(notification);
                }
            }, 300);
        }, 3000);
    }, 100);
}

function showAddToCartError() {
    const notification = document.createElement('div');
    notification.classList.add('cart-notification', 'error');
    notification.innerHTML = `
        <div class="notification-content">
            <span class="notification-icon">âœ—</span>
            <span class="notification-text">Failed to add product to cart. Please try again.</span>
        </div>
    `;
    document.body.appendChild(notification);

    setTimeout(() => {
        notification.classList.add('show');
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    document.body.removeChild(notification);
                }
            }, 300);
        }, 3000);
    }, 100);
}

// Global cart info
let currentCartCount = 0;
let currentCartTotal = 0;
const MINIMUM_ORDER_VALUE = 10000; // $100 in cents

function updateHeaderCartCount() {
    // Update the header cart count
    fetch('/cart.js')
    .then(response => response.json())
    .then(cart => {
        const headerCartCount = document.querySelector('.cart-count');
        if (headerCartCount) {
            headerCartCount.textContent = cart.item_count;
        }
    })
    .catch(error => {
        console.error('Error updating header cart count:', error);
    });
}

function updateCartInfo() {
    // Fetch current cart information
    fetch('/cart.js')
    .then(response => response.json())
    .then(cart => {
        currentCartCount = cart.item_count;
        currentCartTotal = cart.total_price;

        // Only update checkout button if there are items in cart
        if (currentCartCount > 0) {
            updateCheckoutButton();
        } else {
            // Remove checkout section if cart is empty
            const checkoutSection = document.querySelector('.popup-checkout-section');
            if (checkoutSection) {
                checkoutSection.remove();
            }
        }
    })
    .catch(error => {
        console.error('Error fetching cart:', error);
    });
}

function updateCheckoutButton() {
    // Create or update checkout section if it doesn't exist
    let checkoutSection = document.querySelector('.popup-checkout-section');
    const addToCartButton = document.querySelector('.popup-add-to-cart');

    if (!checkoutSection) {
        checkoutSection = document.createElement('div');
        checkoutSection.classList.add('popup-checkout-section');

        // Insert after the add to cart button
        addToCartButton.parentNode.insertBefore(checkoutSection, addToCartButton.nextSibling);
    }

    // Add sticky behavior when cart has items
    if (currentCartCount > 0) {
        checkoutSection.classList.add('sticky-active');
        addToCartButton.classList.add('sticky-active');
    } else {
        checkoutSection.classList.remove('sticky-active');
        addToCartButton.classList.remove('sticky-active');
    }

    // Check if cart meets minimum order value
    const meetsMinimum = currentCartTotal >= MINIMUM_ORDER_VALUE;
    const remaining = MINIMUM_ORDER_VALUE - currentCartTotal;

    // Get actual products from the page (excluding current product) - only show if cart has items and on mobile
    let relatedProductsHTML = '';
    if (currentCartCount > 0 && window.innerWidth < 768) {
        const relatedProducts = getRelatedProducts(); // Get all available products

        if (relatedProducts.length > 0) {
            relatedProductsHTML = `
                <div class="related-products-section">
                    <h3>ðŸ’¡ You might also like</h3>
                    <div class="related-products-grid">
                        ${relatedProducts.map(product => `
                            <div class="related-product-card" onclick="openRelatedProduct('${product.id}', '${product.title.replace(/'/g, "\\'")}', '${product.image}', '${product.sku}', ${product.price}, ${product.variantId})">
                                <div class="related-product-image">
                                    <img src="${product.image}" alt="${product.title}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                    <div class="related-placeholder" style="display: none;">ðŸ“¦</div>
                                </div>
                                <div class="related-product-info">
                                    <h4>${product.title}</h4>
                                    <div class="related-product-price">
                                        <span class="related-sale-price">$${(product.price / 100).toFixed(2)}</span>
                                        <span class="related-final-price">$${(product.finalPrice / 100).toFixed(2)}</span>
                                    </div>
                                    <div class="related-discount-badge">${product.discount}% OFF</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        } else if (window.innerWidth < 768) {
            relatedProductsHTML = `
                <div class="related-products-section">
                    <h3>ðŸ’¡ You might also like</h3>
                    <p style="text-align: center; color: #666; font-size: 12px; margin: 0;">Browse more products on this page</p>
                </div>
            `;
        }
    }

    // Create validation warning if minimum not met
    let validationHTML = '';
    if (!meetsMinimum) {
        validationHTML = `
            <div class="popup-validation-warning">
                <div class="validation-icon">âš ï¸</div>
                <div class="validation-content">
                    <p class="validation-title">Minimum Order Required</p>
                    <p class="validation-message">
                        Add <strong>$${(remaining / 100).toFixed(2)}</strong> more to reach the minimum order value of <strong>$${(MINIMUM_ORDER_VALUE / 100).toFixed(2)}</strong>
                    </p>
                </div>
            </div>
        `;
    }

    const cartText = meetsMinimum
        ? `ðŸ›’ Checkout (${currentCartCount} items - $${(currentCartTotal / 100).toFixed(2)})`
        : `ðŸ”’ Minimum Order Required`;

    checkoutSection.innerHTML = `
        ${validationHTML}
        <div class="checkout-buttons">
            <button class="checkout-btn ${meetsMinimum ? 'primary' : 'disabled'}" onclick="proceedToCheckout()" ${!meetsMinimum ? 'disabled' : ''}>
                <span class="checkout-icon"></span>
                ${cartText}
            </button>
            <button class="checkout-btn secondary" onclick="continueShopping()">
                Continue Shopping
            </button>
        </div>
        ${relatedProductsHTML}
    `;
}

function getRelatedProducts(count = null) {
    const allProductCards = document.querySelectorAll('.product-card');
    const relatedProducts = [];

    // Get all available products that are not the current one
    const availableProducts = Array.from(allProductCards).filter(card => {
        const cardSku = card.querySelector('.product-sku')?.textContent.trim();
        return cardSku && cardSku !== selectedProductSKU;
    });

    // Shuffle and take specified count (or all if count is null)
    const shuffled = availableProducts.sort(() => 0.5 - Math.random());
    const selectedCards = count ? shuffled.slice(0, count) : shuffled;

    selectedCards.forEach(card => {
        const title = card.querySelector('.product-title')?.textContent.trim();
        const sku = card.querySelector('.product-sku')?.textContent.trim();
        const image = card.querySelector('.product-image img')?.src;
        const salePrice = card.querySelector('.sale-price')?.textContent.replace('$', '').replace(/,/g, '');
        const finalPrice = card.querySelector('.final-price')?.textContent.replace('$', '').replace(/,/g, '');
        const discountLabel = card.querySelector('.discount-label')?.textContent;
        const discount = discountLabel ? parseInt(discountLabel.replace(/[^\d]/g, '')) : 0;

        // Get product ID and variant ID from the Shop Now button
        const shopButton = card.querySelector('.product-cta');
        const onclickAttr = shopButton?.getAttribute('onclick');
        let productId = null;
        let variantId = null;

        if (onclickAttr) {
            const matches = onclickAttr.match(/openAddToCartPopupWithEvent\([^,]+,\s*(\d+),.*?,.*?,.*?,.*?,\s*(\d+)\)/);
            if (matches) {
                productId = matches[1];
                variantId = matches[2];
            }
        }

        if (title && sku && image && salePrice && finalPrice && productId && variantId) {
            const salePriceNum = parseFloat(salePrice.replace(/,/g, '')) || 0;
            const finalPriceNum = parseFloat(finalPrice.replace(/,/g, '')) || 0;

            relatedProducts.push({
                id: productId,
                title: title,
                sku: sku,
                image: image,
                price: Math.round(salePriceNum * 100), // Convert to cents
                finalPrice: Math.round(finalPriceNum * 100), // Convert to cents
                discount: discount,
                variantId: variantId
            });
        }
    });

    return relatedProducts;
}

function updateLeftColumnRelatedProducts() {
    const leftRelatedSection = document.getElementById('leftRelatedProducts');
    const leftRelatedGrid = document.getElementById('leftRelatedProductsGrid');

    if (leftRelatedSection && leftRelatedGrid) {
        // Only show if cart has items and on desktop
        if (currentCartCount === 0 || window.innerWidth < 768) {
            leftRelatedSection.style.display = 'none';
            return;
        }

        const relatedProducts = getRelatedProducts(8); // Get up to 8 products for left column

        if (relatedProducts.length > 0) {
            leftRelatedGrid.innerHTML = relatedProducts.map(product => `
                <div class="left-related-product-card" onclick="openRelatedProduct('${product.id}', '${product.title.replace(/'/g, "\\'")}', '${product.image}', '${product.sku}', ${product.price}, ${product.variantId})">
                    <div class="left-related-product-image">
                        <img src="${product.image}" alt="${product.title}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="related-placeholder" style="display: none;">ðŸ“¦</div>
                    </div>
                    <div class="left-related-product-info">
                        <h4>${product.title}</h4>
                        <div class="left-related-product-price">
                            <span class="left-related-sale-price">$${(product.price / 100).toFixed(2)}</span>
                            <span class="left-related-final-price">$${(product.finalPrice / 100).toFixed(2)}</span>
                        </div>
                        <div class="left-related-discount-badge">${product.discount}% OFF</div>
                    </div>
                </div>
            `).join('');
            leftRelatedSection.style.display = 'block';
        } else {
            leftRelatedSection.style.display = 'none';
        }
    }
}

function updateRelatedProducts() {
    // Update the related products section with new recommendations
    const relatedProductsSection = document.querySelector('.related-products-section');
    if (relatedProductsSection) {
        const relatedProducts = getRelatedProducts(); // Get all available products
        const relatedProductsGrid = relatedProductsSection.querySelector('.related-products-grid');

        if (relatedProductsGrid && relatedProducts.length > 0) {
            relatedProductsGrid.innerHTML = relatedProducts.map(product => `
                <div class="related-product-card" onclick="openRelatedProduct('${product.id}', '${product.title.replace(/'/g, "\\'")}', '${product.image}', '${product.sku}', ${product.price}, ${product.variantId})">
                    <div class="related-product-image">
                        <img src="${product.image}" alt="${product.title}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="related-placeholder" style="display: none;">ðŸ“¦</div>
                    </div>
                    <div class="related-product-info">
                        <h4>${product.title}</h4>
                        <div class="related-product-price">
                            <span class="related-sale-price">$${(product.price / 100).toFixed(2)}</span>
                            <span class="related-final-price">$${(product.finalPrice / 100).toFixed(2)}</span>
                        </div>
                        <div class="related-discount-badge">${product.discount}% OFF</div>
                    </div>
                </div>
            `).join('');
        }
    }
}

function openRelatedProduct(productId, productTitle, productImage, productSKU, productPrice, productVariantId) {
    // Don't close the popup - just update the content directly
    // Find the product card to get discount and compare at price information
    const productCards = document.querySelectorAll('.product-card');
    let compareAtPrice = 0;
    let productCard = null;

    // Find the matching product card by SKU
    for (const card of productCards) {
        const cardSku = card.querySelector('.product-sku')?.textContent.trim();
        if (cardSku === productSKU) {
            productCard = card;
            // Get compare at price from original price if it exists
            const originalPriceEl = card.querySelector('.original-price');
            if (originalPriceEl) {
                const originalPriceText = originalPriceEl.textContent.replace('$', '').replace(/,/g, '');
                compareAtPrice = Math.round(parseFloat(originalPriceText) * 100);
            }
            break;
        }
    }

    // Create a fake event object with the found product card
    const fakeEvent = {
        target: productCard || document.querySelector(`[onclick*="${productId}"]`),
        stopPropagation: () => {}
    };

    // Update the popup content with new product data
    selectedProductId = productId;
    selectedProductTitle = productTitle;
    selectedProductImage = productImage;
    selectedProductSKU = productSKU;
    selectedProductPrice = productPrice;
    selectedProductVariantId = productVariantId;
    selectedProductCompareAtPrice = compareAtPrice;

    // Find discount information from the product card
    let discountPercentage = 0;
    let finalPrice = productPrice;

    if (productCard) {
        const discountLabel = productCard.querySelector('.discount-label');
        if (discountLabel) {
            const discountText = discountLabel.textContent;
            discountPercentage = parseInt(discountText.replace(/[^\d]/g, '')) || 0;

            // Calculate final price properly
            if (discountPercentage > 0) {
                finalPrice = productPrice * (1 - discountPercentage / 100);
            }
        }
    }

    selectedProductDiscount = discountPercentage;

    // Helper function to format price
    function formatPrice(price) {
        const priceInNumber = Number(price);
        return priceInNumber.toFixed(2);
    }

    // Update popup content immediately
    const popupImageEl = document.getElementById('popupProductImage');
    const popupTitleEl = document.getElementById('popupProductTitle');
    const popupSKUEl = document.getElementById('popupProductSKU');

    if (popupImageEl) popupImageEl.src = productImage;
    if (popupTitleEl) popupTitleEl.textContent = productTitle;
    if (popupSKUEl) popupSKUEl.textContent = productSKU;

    // Update original price in the popup
    const originalPriceElement = document.getElementById('popupOriginalPrice');
    if (selectedProductCompareAtPrice > 0){
        originalPriceElement.textContent = '$' + formatPrice(selectedProductCompareAtPrice / 100);
        originalPriceElement.style.display = 'inline';
    } else {
        originalPriceElement.style.display = 'none';
    }

    const popupSalePriceEl = document.getElementById('popupSalePrice');
    const popupFinalPriceEl = document.getElementById('popupFinalPrice');
    const popupQuantityEl = document.getElementById('popupQuantity');

    if (popupSalePriceEl) popupSalePriceEl.textContent = formatPrice(productPrice / 100);
    if (popupFinalPriceEl) popupFinalPriceEl.textContent = '$' + formatPrice(finalPrice / 100);
    if (popupQuantityEl) popupQuantityEl.value = 1;

    // Show discount badge with the SAME percentage as the product card
    const discountBadge = document.getElementById('popupDiscountBadge');
    if (discountPercentage > 0) {
        discountBadge.textContent = discountPercentage + '% OFF';
        discountBadge.style.display = 'block';
    } else {
        discountBadge.style.display = 'none';
    }

    // Calculate smart savings for different quantities
    const priceInDollars = productPrice / 100;

    // Calculate for 2+ items
    const qty2 = 2;
    const regularTotal2 = priceInDollars * qty2;
    const discountedTotal2 = regularTotal2 * (1 - discountPercentage / 100);
    const totalSavings2 = regularTotal2 - discountedTotal2;
    const perItemSavings2 = totalSavings2 / qty2;

    // Calculate for 3+ items
    const qty3 = 3;
    const bulkDiscount3 = discountPercentage + 5;
    const regularTotal3 = priceInDollars * qty3;
    const discountedTotal3 = regularTotal3 * (1 - bulkDiscount3 / 100);
    const totalSavings3 = regularTotal3 - discountedTotal3;
    const perItemSavings3 = totalSavings3 / qty3;

    // Calculate for 5+ items
    const qty5 = 5;
    const bulkDiscount5 = discountPercentage + 10;
    const regularTotal5 = priceInDollars * qty5;
    const discountedTotal5 = regularTotal5 * (1 - bulkDiscount5 / 100);
    const totalSavings5 = regularTotal5 - discountedTotal5;
    const perItemSavings5 = totalSavings5 / qty5;

    const popupSavingsPreviewEl = document.getElementById('popupSavingsPreview');
    const popupSavingsAmount2El = document.getElementById('popupSavingsAmount2');
    const popupSavingsAmount3El = document.getElementById('popupSavingsAmount3');
    const popupSavingsAmount5El = document.getElementById('popupSavingsAmount5');

    if (popupSavingsPreviewEl) popupSavingsPreviewEl.textContent = formatPrice(perItemSavings2);
    if (popupSavingsAmount2El) popupSavingsAmount2El.textContent = formatPrice(perItemSavings2);
    if (popupSavingsAmount3El) popupSavingsAmount3El.textContent = formatPrice(perItemSavings3);
    if (popupSavingsAmount5El) popupSavingsAmount5El.textContent = formatPrice(perItemSavings5);

    // Reset savings selections
    document.querySelectorAll('.popup-savings-option').forEach(option => {
        option.classList.remove('selected');
    });

    // Update related products section with new recommendations
    updateRelatedProducts();

    // Update left column related products
    updateLeftColumnRelatedProducts();
}

function proceedToCheckout() {
    // Validate minimum order before proceeding
    if (currentCartTotal < MINIMUM_ORDER_VALUE) {
        showMinimumOrderModal();
        return;
    }

    // Additional validation - check for automatic coupon codes
    validateCartAndProceed();
}

function validateCartAndProceed() {
    // Fetch current cart to check for automatic discounts
    fetch('/cart.js')
    .then(response => response.json())
    .then(cart => {
        // Update current total in case automatic coupons were applied
        currentCartTotal = cart.total_price;

        // Check again after potential coupon application
        if (currentCartTotal < MINIMUM_ORDER_VALUE) {
            showMinimumOrderModal();
            return;
        }

        // Proceed to checkout
        window.location.href = '/checkout';
    })
    .catch(error => {
        console.error('Error validating cart:', error);
        // Proceed anyway if validation fails
        window.location.href = '/checkout';
    });
}

function showMinimumOrderModal() {
    const remaining = MINIMUM_ORDER_VALUE - currentCartTotal;

    // Create modal HTML
    const modalHTML = `
        <div class="popup-validation-modal" id="popup-validation-modal">
            <div class="popup-validation-overlay" onclick="closeValidationModal()"></div>
            <div class="popup-validation-content">
                <div class="popup-validation-header">
                    <h3>ðŸ›’ Minimum Order Required</h3>
                    <button class="popup-validation-close" onclick="closeValidationModal()">Ã—</button>
                </div>
                <div class="popup-validation-body">
                    <div class="validation-info">
                        <p><strong>Current Total:</strong> $${(currentCartTotal / 100).toFixed(2)}</p>
                        <p><strong>Required Minimum:</strong> $${(MINIMUM_ORDER_VALUE / 100).toFixed(2)}</p>
                        <p class="amount-needed"><strong>Amount Needed:</strong> $${(remaining / 100).toFixed(2)}</p>
                    </div>
                    <div class="security-notice">
                        <div class="security-icon">ðŸ›¡ï¸</div>
                        <span class="security-text">This validation is enforced server-side and cannot be bypassed. Your cart must meet the minimum order requirement to proceed.</span>
                    </div>
                </div>
                <div class="popup-validation-footer">
                    <button class="validation-btn primary" onclick="continueShopping()">ðŸ›ï¸ Continue Shopping</button>
                    <button class="validation-btn secondary" onclick="closeValidationModal()">Cancel</button>
                </div>
            </div>
        </div>
    `;

    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modalHTML);

    // Show modal
    const modal = document.getElementById('popup-validation-modal');
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

function closeValidationModal() {
    const modal = document.getElementById('popup-validation-modal');
    if (modal) {
        modal.remove();
    }
    document.body.style.overflow = 'auto';
}

function continueShopping() {
    closeAddToCartPopup();
}

function addRelatedProduct(sku, title, price) {
    // Add related product to cart
    fetch('/cart/add.js', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            id: sku, // You may need to map SKU to variant ID
            quantity: 1
        })
    })
    .then(response => response.json())
    .then(data => {
        showAddToCartSuccess();
    })
    .catch(error => {
        console.error('Error adding related product:', error);
        showAddToCartError();
    });
}

// Function to copy collection title URL to clipboard
function copyCollectionURL(event, anchorId, title) {
    event.preventDefault();
    event.stopPropagation();

    const fullURL = window.location.origin + window.location.pathname + '#' + anchorId;

    navigator.clipboard.writeText(fullURL)
        .then(() => {
            // Show toast notification
            const toast = document.createElement('div');
            toast.classList.add('toast');
            toast.textContent = 'Collection URL copied: ' + title;
            document.body.appendChild(toast);

            // Animate toast
            setTimeout(() => {
                toast.classList.add('show');
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => {
                        if (document.body.contains(toast)) {
                            document.body.removeChild(toast);
                        }
                    }, 300);
                }, 3000);
            }, 100);
        })
        .catch(err => {
            console.error('Could not copy URL: ', err);
            // Fallback toast for error
            const errorToast = document.createElement('div');
            errorToast.classList.add('toast');
            errorToast.textContent = 'Failed to copy URL. Please try again.';
            errorToast.style.background = '#dc3545';
            document.body.appendChild(errorToast);
            setTimeout(() => {
                errorToast.classList.add('show');
                setTimeout(() => {
                    errorToast.classList.remove('show');
                    setTimeout(() => {
                        if (document.body.contains(errorToast)) {
                            document.body.removeChild(errorToast);
                        }
                    }, 300);
                }, 2000);
            }, 100);
        });
}

// Start countdown when page loads
document.addEventListener('DOMContentLoaded', function() {
  updateCountdown();
  calculatePricesAndSavings();

  // Initialize cart info
  updateCartInfo();

  // Handle URL hash navigation on page load
  handleHashNavigation();

  // Handle hash changes (when user navigates back/forward)
  window.addEventListener('hashchange', handleHashNavigation);
});

// Function to handle URL hash navigation
function handleHashNavigation() {
  const hash = window.location.hash;
  if (hash) {
    const targetElement = document.querySelector(hash);
    if (targetElement) {
      // Small delay to ensure page is fully loaded
      setTimeout(() => {
        targetElement.scrollIntoView({
          behavior: 'smooth',
          block: 'start'
        });
      }, 100);
    }
  }
}
</script>