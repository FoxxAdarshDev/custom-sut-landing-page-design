);

        // Update cart count and show checkout section now that cart has items
        updateCartInfo();
        
        // Reset quantity to 1 after adding
        document.getElementById('popupQuantity').value = 1;
        
        // Keep the Add to Cart button visible alongside checkout options
        const addToCartBtn = document.querySelector('.popup-add-to-cart');
        if (addToCartBtn) {
            addToCartBtn.style.display = 'block';
        }
    })
    .catch(error => {
        console.error('Error adding to cart:', error);
        showAddToCartError();
    });
}

function showAddToCartSuccess() {
    // Create and show success notification
    const notification = document.createElement('div');
    notification.classList.add('cart-notification', 'success');
    notification.innerHTML = `
        <div class="notification-content">
            <span class="notification-icon">âœ“</span>
            <span class="notification-text">Product added to cart successfully!</span>
        </div>
    `;
    document.body.appendChild(notification);

    setTimeout(() => {
        notification.classList.add('show');
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    document.body.removeChild(notification);
                }
            }, 300);
        }, 3000);
    }, 100);
}

function showAddToCartError() {
    const notification = document.createElement('div');
    notification.classList.add('cart-notification', 'error');
    notification.innerHTML = `
        <div class="notification-content">
            <span class="notification-icon">âœ—</span>
            <span class="notification-text">Failed to add product to cart. Please try again.</span>
        </div>
    `;
    document.body.appendChild(notification);

    setTimeout(() => {
        notification.classList.add('show');
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    document.body.removeChild(notification);
                }
            }, 300);
        }, 3000);
    }, 100);
}

// Global cart info
let currentCartCount = 0;
let currentCartTotal = 0;

function updateCartInfo() {
    // Fetch current cart information
    fetch('/cart.js')
    .then(response => response.json())
    .then(cart => {
        currentCartCount = cart.item_count;
        currentCartTotal = cart.total_price;
        
        // Only update checkout button if there are items in cart
        if (currentCartCount > 0) {
            updateCheckoutButton();
        } else {
            // Remove checkout section if cart is empty
            const checkoutSection = document.querySelector('.popup-checkout-section');
            if (checkoutSection) {
                checkoutSection.remove();
            }
        }
    })
    .catch(error => {
        console.error('Error fetching cart:', error);
    });
}

function updateCheckoutButton() {
    // Create or update checkout section if it doesn't exist
    let checkoutSection = document.querySelector('.popup-checkout-section');
    
    if (!checkoutSection) {
        checkoutSection = document.createElement('div');
        checkoutSection.classList.add('popup-checkout-section');
        
        // Insert after the add to cart button
        const addToCartButton = document.querySelector('.popup-add-to-cart');
        addToCartButton.parentNode.insertBefore(checkoutSection, addToCartButton.nextSibling);
    }
    
    // Get actual products from the page (excluding current product)
    const relatedProducts = getRelatedProducts();

    let relatedProductsHTML = '';
    if (relatedProducts.length > 0) {
        relatedProductsHTML = `
            <div class="related-products-section">
                <h3>You might also like</h3>
                <div class="related-products-grid">
                    ${relatedProducts.map(product => `
                        <div class="related-product-card" onclick="openRelatedProduct('${product.id}', '${product.title.replace(/'/g, "\\'")}', '${product.image}', '${product.sku}', ${product.price}, ${product.variantId})">
                            <div class="related-product-image">
                                <img src="${product.image}" alt="${product.title}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                <div class="related-placeholder" style="display: none;">ðŸ“¦</div>
                            </div>
                            <div class="related-product-info">
                                <h4>${product.title}</h4>
                                <div class="related-product-price">
                                    <span class="related-sale-price">$${(product.price / 100).toFixed(2)}</span>
                                    <span class="related-final-price">$${(product.finalPrice / 100).toFixed(2)}</span>
                                </div>
                                <div class="related-discount-badge">${product.discount}% OFF</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    } else {
        relatedProductsHTML = `
            <div class="related-products-section">
                <h3>You might also like</h3>
                <p>More products available on this page...</p>
            </div>
        `;
    }

    const cartText = `ðŸ›’ Checkout (${currentCartCount} items - $${(currentCartTotal / 100).toFixed(2)})`;

    checkoutSection.innerHTML = `
        <div class="checkout-buttons">
            <button class="checkout-btn primary" onclick="proceedToCheckout()">
                <span class="checkout-icon"></span>
                ${cartText}
            </button>
            <button class="checkout-btn secondary" onclick="continueShopping()">
                Continue Shopping
            </button>
        </div>
        ${relatedProductsHTML}
    `;
}

function getRelatedProducts() {
    const allProductCards = document.querySelectorAll('.product-card');
    const relatedProducts = [];

    // Get up to 2 random products that are not the current one
    const availableProducts = Array.from(allProductCards).filter(card => {
        const cardSku = card.querySelector('.product-sku')?.textContent.trim();
        return cardSku && cardSku !== selectedProductSKU;
    });

    // Shuffle and take first 2
    const shuffled = availableProducts.sort(() => 0.5 - Math.random());
    const selectedCards = shuffled.slice(0, 2);

    selectedCards.forEach(card => {
        const title = card.querySelector('.product-title')?.textContent.trim();
        const sku = card.querySelector('.product-sku')?.textContent.trim();
        const image = card.querySelector('.product-image img')?.src;
        const salePrice = card.querySelector('.sale-price')?.textContent.replace('$', '').replace(/,/g, '');
        const finalPrice = card.querySelector('.final-price')?.textContent.replace('$', '').replace(/,/g, '');
        const discountLabel = card.querySelector('.discount-label')?.textContent;
        const discount = discountLabel ? parseInt(discountLabel.replace(/[^\d]/g, '')) : 0;

        // Get product ID and variant ID from the Shop Now button
        const shopButton = card.querySelector('.product-cta');
        const onclickAttr = shopButton?.getAttribute('onclick');
        let productId = null;
        let variantId = null;

        if (onclickAttr) {
            const matches = onclickAttr.match(/openAddToCartPopupWithEvent\([^,]+,\s*(\d+),.*?,.*?,.*?,.*?,\s*(\d+)\)/);
            if (matches) {
                productId = matches[1];
                variantId = matches[2];
            }
        }

        if (title && sku && image && salePrice && finalPrice && productId && variantId) {
            relatedProducts.push({
                id: productId,
                title: title,
                sku: sku,
                image: image,
                price: Math.round(parseFloat(salePrice) * 100), // Convert to cents
                finalPrice: Math.round(parseFloat(finalPrice) * 100), // Convert to cents
                discount: discount,
                variantId: variantId
            });
        }
    });

    return relatedProducts;
}

function openRelatedProduct(productId, productTitle, productImage, productSKU, productPrice, productVariantId) {
    // Close current popup
    closeAddToCartPopup();

    // Small delay then open new popup
    setTimeout(() => {
        // Create a fake event object
        const fakeEvent = {
            target: document.querySelector(`[onclick*="${productId}"]`),
            stopPropagation: () => {}
        };

        openAddToCartPopup(productId, productTitle, productImage, productSKU, productPrice, productVariantId, fakeEvent);
    }, 300);
}

function proceedToCheckout() {
    // Redirect to Shopify checkout page directly
    window.location.href = '/checkout';
}

function continueShopping() {
    closeAddToCartPopup();
}

function addRelatedProduct(sku, title, price) {
    // Add related product to cart
    fetch('/cart/add.js', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            id: sku, // You may need to map SKU to variant ID
            quantity: 1
        })
    })
    .then(response => response.json())
    .then(data => {
        showAddToCartSuccess();
    })
    .catch(error => {
        console.error('Error adding related product:', error);
        showAddToCartError();
    });
}

// Start countdown when page loads
document.addEventListener('DOMContentLoaded', function() {
  updateCountdown();
  calculatePricesAndSavings();
  
  // Initialize cart info
  updateCartInfo();
});
</script>