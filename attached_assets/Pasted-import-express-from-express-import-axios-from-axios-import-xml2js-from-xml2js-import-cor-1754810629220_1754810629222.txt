import express from "express";
import axios from "axios";
import xml2js from "xml2js";
import cors from 'cors';

const app = express();

// Enable CORS for all routes
const corsOptions = {
  origin: [
    'https://shopfls.myshopify.com',
    'http://127.0.0.1:5500/',
    'https://www.foxxlifesciences.com/pages/copy-of-video-gallery',
    'https://fls-youtube-videos-fetch-with-api-e1dv.onrender.com/',
    'https://www.foxxlifesciences.com',
    'https://foxxbioprocess.com',
    "https://foxxbioprocess.com/",
    "https://foxxbioprocess.myshopify.com"
  ],
  optionsSuccessStatus: 200,
};

app.use(cors(corsOptions));

const PORT = process.env.PORT || 1000;

// Define your playlists
const playlists = [
  { id: 'PLpCwULorl7qE_RXFChFAztQ4_G8NXZ_cq', containerId: 'trade-shows' },
   { id: 'PLpCwULorl7qFZPqAzk_cdJwnaRRI0Tms7', containerId: 'Product Videos' },
      { id: 'PLpCwULorl7qGRRKCAIz7lhqSUgmce3ybM', containerId: 'Foxx Shorts' },
  { id: 'PLpCwULorl7qGB0hR3Cz36eDc4LXGbxwP6', containerId: 'corporate' },
  { id: 'PLpCwULorl7qGXamhf5PNyYLoNw4MyrS-C', containerId: 'training' },
  { id: 'PLpCwULorl7qFR4xKtcMkanrVGHgeRJ6Ue', containerId: 'filtration' },
  { id: 'PLpCwULorl7qHxFKd4uR18xGUaF6tjAiBD', containerId: 'laboratory-safety' },
  { id: 'PLpCwULorl7qGtpVNLp-4-gg3DeVeJTPhL', containerId: 'laboratory-glassware' },
  { id: 'PLpCwULorl7qE86Mjbbz6_dq8ebNNNO0O2', containerId: 'bottles-carboys-cans' },
  { id: 'PLpCwULorl7qEphXOBxoHjuueeUdb6fxvL', containerId: 'bioprocess-single-use' },
  { id: 'PLpCwULorl7qE3LTbgDo7UbChl164CglUr', containerId: 'bioprocess-caps' },
];

// Function to fetch videos for a given playlist
const fetchVideos = async (playlistId) => {
  const rssFeedUrl = `https://www.youtube.com/feeds/videos.xml?playlist_id=${playlistId}`;
  const response = await axios.get(rssFeedUrl);
  const xmlData = response.data;
  const result = await xml2js.parseStringPromise(xmlData);

  if (result.feed && Array.isArray(result.feed.entry)) {
    return result.feed.entry
      .map((video) => {
        const mediaGroup = video["media:group"] && video["media:group"][0];
        return {
          title:
            mediaGroup && mediaGroup["media:title"]
              ? mediaGroup["media:title"][0]
              : "N/A",
          videoId: video["yt:videoId"] ? video["yt:videoId"][0] : "N/A",
          published: video.published ? video.published[0] : "N/A",
          description:
            mediaGroup && mediaGroup["media:description"]
              ? mediaGroup["media:description"][0]
              : "N/A",
          link:
            video.link && video.link[0] && video.link[0].$
              ? video.link[0].$.href
              : "N/A",
        };
      })
      .sort((a, b) => new Date(b.published) - new Date(a.published)); // Sort by published date
  } else {
    return []; // Return an empty array if no entries found
  }
};

// Endpoint to serve the videos of a specific playlist
app.get("/videos/:playlistId", async (req, res) => {
  const playlistId = req.params.playlistId;

  try {
    const videos = await fetchVideos(playlistId);

    // Function to format the description
    function formatDescription(description) {
      description = description.replace(
        /(https?:\/\/[^\s]+)/g,
        '<a href="$1" target="_blank">$1</a>'
      );
      description = description.replace(
        /#(\w+)/g,
        '<a href="https://www.youtube.com/hashtag/$1" target="_blank">#$1</a>'
      );
      const paragraphs = description
        .split(/(?<=\.)\s+|\n+/g)
        .filter((paragraph) => paragraph.trim() !== "");
      return paragraphs.map((paragraph) => `<p>${paragraph}</p>`).join("");
    }

    function timeAgo(publishedDate) {
      const now = new Date();
      const then = new Date(publishedDate);
      const seconds = Math.floor((now - then) / 1000);
      const interval = Math.floor(seconds / 31536000);
      if (interval > 1) return `${interval} years ago`;
      const intervalMonths = Math.floor(seconds / 2592000);
      if (intervalMonths > 1) return `${intervalMonths} months ago`;
      const intervalDays = Math.floor(seconds / 86400);
      if (intervalDays > 1) return `${intervalDays} days ago`;
      const intervalHours = Math.floor(seconds / 3600);
      if (intervalHours > 1) return `${intervalHours} hours ago`;
      const intervalMinutes = Math.floor(seconds / 60);
      if (intervalMinutes > 1) return `${intervalMinutes} minutes ago`;
      return `${Math.floor(seconds)} seconds ago`;
    }

    let htmlResponse = `
      <div class="youtube_video-container">
    `;

    if (videos.length === 0) {
      htmlResponse += "<p>No videos found in this playlist.</p>";
    } else {
      videos.forEach((video) => {
        htmlResponse += `
          <div class="youtube_video-item">
  <iframe src="https://www.youtube.com/embed/${
    video.videoId
  }" frameborder="0" allowfullscreen></iframe>
  <div class="youtube_video-details">
    <h2 class="youtube_video-title"><a href="${video.link}" target="_blank">${
          video.title
        }</a></h2>
    <p class="youtube_video-date">${timeAgo(video.published)}</p>
    <p class="youtube_read-more" 
       data-video-id="${video.videoId}"
       data-title="${video.title.replace(/"/g, "&quot;")}"
       data-description="${formatDescription(video.description).replace(
         /"/g,
         "&quot;"
       )}">Read More</p>
  </div>
</div>

        `;
      });
    }

    htmlResponse += `
      </div>
    `;

    res.send(htmlResponse);
  } catch (error) {
    console.error("Error fetching videos:", error);
    res.status(500).send("Error fetching videos");
  }
});

// Serve the main HTML page with tabs
app.get("/videos", (req, res) => {
  let tabsHtml = playlists
    .map(
      (playlist, index) => `
    <button class="youtube_tab-button${
      index === 0 ? " active" : ""
    }" data-playlist-id="${playlist.id}">${playlist.containerId
        .replace(/-/g, " ")
        .toUpperCase()}</button>
  `
    )
    .join("");

  res.send(`
   
      <style>
    
     .youtube_tab-container-main {
      display:flex;
      align-items:center;
      justify-content:center;
      }
        .youtube_tab-button {
          background-color: #ddd;
          border: none;
          border-radius: 20px;
          cursor: pointer;
          padding: 10px 20px;
          margin: 5px;
        }
        .youtube_tab-button.active {
          background-color: #095ea7;
          color: white;
        }
        .youtube_video-container {
          display: flex;
          flex-wrap: wrap;
          justify-content: center;
          gap:5px;
        }
                  .youtube_video-item {
              background-color: #ffffff;
              border: 2px solid #095ea7; /* Blue border */
              border-radius: 10px; /* Rounded corners */
              overflow: hidden;
              box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
              margin: 15px;
              max-width: 350px;
              transition: transform 0.3s, box-shadow 0.3s;
            }

            .youtube_video-item:hover {
              transform: translateY(-5px); /* Slightly raise the card */
              box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
            }

            iframe {
              width: 100%;
              height: 200px;
              border: none;
            }

            .youtube_video-details {
              padding: 15px;
            }

            .youtube_video-title {
              font-size: 18px;
              margin: 0;
              color: #333;
            }

            .youtube_video-title a {
              text-decoration: none;
              color: inherit;
              transition: color 0.3s;
            }

            .youtube_video-title a:hover {
              color: #095ea7; /* Hover color */
            }

            .youtube_video-date {
              font-size: 0.875em;
              color: #777;
              margin: 5px 0;
            }

            .youtube_read-more {
              cursor: pointer;
              color: #095ea7;
              text-decoration: underline;
              margin-top: 10px;
              display: inline-block;
              transition: color 0.3s;
            }

            .youtube_read-more:hover {
              color: #095ea7; /* Darker blue for hover */
            }

            @media screen and (max-width: 767px) {
            .youtube_tab-container {
            display:grid;
            grid-template-columns: repeat(100000, 1fr);
            overflow-x: scroll;
            }

            .youtube_tab-button {
            height:50px;
            width:200px;}
               }

              .youtube_modal {
                      display: none; /* Hidden by default */
                      position: fixed;
                      z-index: 1; /* Sit on top */
                      left: 0;
                      top: 0;
                      width: 100%; /* Full width */
                      height: 100%; /* Full height */
                      overflow: auto; /* Enable scroll if needed */
                      background-color: rgb(0,0,0); /* Fallback color */
                      background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
                  }
                   .youtube_modal-content {
                      background-color: #fefefe;
                      margin: 15% auto;
                      padding: 20px;
                      border: 1px solid #888;
                      width: 80%; /* Adjust as needed */
                      max-width: 800px; /* Ensure it doesn't exceed a max width */
                  }

                #modalIframe {
                    width: 100%;
                    height: 450px; /* Adjust height as needed */
                }
                  .youtube_modal-close {
                      color: #aaa;
                      float: right;
                      font-size: 28px;
                      font-weight: bold;
                  }
                  .youtube_modal-close:hover,
                  .youtube_modal-close:focus {
                      color: black;
                      text-decoration: none;
                      cursor: pointer;
                  }
      </style>
     <script>
  document.addEventListener('DOMContentLoaded', () => {
    const buttons = document.querySelectorAll('.youtube_tab-button');
    const container = document.querySelector('.youtube_video-container');
    
    // Load the videos for the initial tab
    loadVideos(buttons[0].getAttribute('data-playlist-id'));

    buttons.forEach(button => {
      button.addEventListener('click', () => {
        buttons.forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');
        loadVideos(button.getAttribute('data-playlist-id'));
      });
    });

    function loadVideos(playlistId) {
      fetch('/videos/' + playlistId)
        .then(response => response.text())
        .then(html => {
          container.innerHTML = html;
        });
    }

    // Event delegation for handling "Read More" clicks
    container.addEventListener('click', (event) => {
      if (event.target && event.target.classList.contains('youtube_read-more')) {
        toggleDescription(event);
      }
    });

    function toggleDescription(event) {
      const target = event.target;
      const videoId = target.getAttribute('data-video-id');
      const title = target.getAttribute('data-title');
      const description = target.getAttribute('data-description');
  
      // Show modal with the video details
      showModal(videoId, title, description);
    }

   function showModal(videoId, title, description) {
  const modal = document.getElementById("videoModal");
  const modalTitle = document.getElementById("modalTitle");
  const modalIframe = document.getElementById("modalIframe");
  const modalDescription = document.getElementById("modalDescription");
  const closeBtn = document.querySelector(".youtube_modal .youtube_modal-close");

  modalTitle.textContent = title;
  // Updated src URL to include autoplay and mute parameters
  modalIframe.src = "https://www.youtube.com/embed/" + encodeURIComponent(videoId) + "?autoplay=1&mute=1";
  modalDescription.innerHTML = description;

  modal.style.display = "block";

  closeBtn.onclick = function() {
    modal.style.display = "none";
    // Stop the video by clearing the iframe src
    modalIframe.src = "";
  }

  window.onclick = function(event) {
    if (event.target === modal) {
      modal.style.display = "none";
      // Stop the video by clearing the iframe src
      modalIframe.src = "";
    }
  }
}
  });
</script>

          <div id="videoModal" class="youtube_modal">
              <div class="youtube_modal-content">
                  <span class="youtube_modal-close">&times;</span>
                  <h2 id="modalTitle"></h2>
                  <iframe id="modalIframe" width="560" height="315" frameborder="0" allowfullscreen></iframe>
                  <p id="modalDescription"></p>
              </div>
          </div>
         <div class="youtube_tab-container-main">
          <div class="youtube_tab-container">
          ${tabsHtml}
        </div>
        </div>
         <div class="youtube_video-container"></div>
  `);
});

app.listen(PORT, () => {
  console.log(`Server is running on port ${PORT}`);
});
