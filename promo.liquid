<style>
  .patriotic-sale-container {
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 50%, #e9ecef 100%);
    min-height: 100vh;
    padding: 40px 20px;
  }

  .sale-header {
    margin-bottom: 30px;
    padding: 30px 20px;
    background: transparent;
    border-radius: 20px;
    color: #333;
    box-shadow: none;
    position: relative;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 40px;
    min-height: 400px;
  }

  .independence-badge {
    background: #dc3545;
    color: white;
    padding: 8px 20px;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: 700;
    display: inline-block;
    margin-bottom: 20px;
    text-transform: uppercase;
    letter-spacing: 1px;
  }

  .hero-left {
    flex: 1;
    text-align: left;
    max-width: 500px;
  }

  .hero-right {
    flex: 0 0 350px;
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  .sale-header h1 {
    font-size: clamp(2rem, 5vw, 3.5rem);
    font-weight: 900;
    margin-bottom: 15px;
    color: #0071ce;
    letter-spacing: 1px;
    line-height: 1.1;
  }

  .sale-header h1 .gradient-text {
    background: linear-gradient(45deg, #0071ce 0%, #dc3545 50%, #0071ce 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .sale-header .discount {
    font-size: clamp(1.8rem, 4vw, 2.8rem);
    font-weight: 900;
    color: #dc3545;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    margin-bottom: 15px;
    letter-spacing: 1px;
  }

  .sale-subtitle {
    font-size: clamp(0.9rem, 1.8vw, 1.1rem);
    color: #666;
    font-weight: 400;
    line-height: 1.4;
    margin-bottom: 25px;
  }

  .header-timer {
    background: white;
    border: 2px solid #dc3545;
    border-radius: 12px;
    padding: 20px 15px;
    width: 100%;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
  }

  .header-timer-label {
    color: #dc3545;
    font-size: 1rem;
    font-weight: 700;
    margin-bottom: 15px;
    text-transform: uppercase;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    letter-spacing: 1px;
  }

  .header-countdown {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 6px;
  }

  .header-countdown-unit {
    background: white;
    border: 2px solid #dc3545;
    border-radius: 8px;
    padding: 8px 4px;
    text-align: center;
    transition: transform 0.3s ease;
  }

  .header-countdown-unit:hover {
    transform: translateY(-2px);
    box-shadow: 0 2px 8px rgba(220, 53, 69, 0.2);
  }

  .header-countdown-unit span {
    display: block;
    font-size: 1.2rem;
    font-weight: 900;
    color: #dc3545;
    line-height: 1;
    margin-bottom: 2px;
    font-family: 'Arial', sans-serif;
  }

  .header-countdown-unit label {
    font-size: 0.6rem;
    font-weight: 700;
    color: #dc3545;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .shop-now-cta {
    background: linear-gradient(45deg, #0071ce, #dc3545);
    color: white;
    padding: 12px 30px;
    border: none;
    border-radius: 25px;
    font-weight: 900;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
    display: inline-block;
    text-transform: uppercase;
    letter-spacing: 1px;
    box-shadow: 0 5px 15px rgba(0, 113, 206, 0.3);
  }

  .shop-now-cta:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 25px rgba(220, 53, 69, 0.5);
    color: white;
    text-decoration: none;
    filter: brightness(1.1);
  }

  .tabs-container {
    max-width: 100%;
    margin: 0 auto;
  }

  .collection-section {
    margin-bottom: 80px;
    background: white;
    border-radius: 20px;
    overflow: hidden;
    border: 2px solid #e5e7eb;
  }

  .collection-header {
    padding: 20px 40px;
    background: white;
    display: flex;
    align-items: center;
    gap: 20px;
    min-height: auto;
  }

  .collection-title {
    font-size: 1.8rem;
    font-weight: 700;
    color: #0071ce;
    margin-bottom: 10px;
    line-height: 1.2;
  }

  .products-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 30px;
    padding: 40px;
  }

  .product-card {
    background: white;
    border-radius: 15px;
    overflow: hidden;
    transition: all 0.3s ease;
    border: 2px solid #0071ce;
    position: relative;
    max-width: 400px;
    width: 100%;
    margin: 0 auto;
  }

  .product-card:hover {
    transform: translateY(-2px);
    border-color: #005ba6;
  }

  .discount-badge {
    position: absolute;
    top: -0px;
    right: -8px;
    z-index: 10;
  }

  .discount-label {
    background: #dc3545 !important;
    color: white !important;
    padding: 6px 14px 6px 10px;
    font-weight: 700;
    font-size: 0.75rem;
    text-align: center;
    position: relative;
    display: inline-flex;
    align-items: center;
    min-height: 24px;
    border-radius: 0 3px 3px 0;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
  }

  .product-image {
    height: 220px;
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 30px 20px;
    border-bottom: 1px solid #e0e0e0;
  }

  .product-image img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
  }

  .product-content {
    padding: 20px;
  }

  .product-title {
    font-size: 1rem;
    font-weight: 600;
    color: #0071ce;
    margin-bottom: 12px;
    line-height: 1.4;
    min-height: 48px;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .product-sku {
    color: #666;
    font-size: 0.85rem;
    margin-bottom: 6px;
    font-weight: 500;
    display: flex;
    align-items: center;
    justify-content: flex-start;
    cursor: pointer;
    gap: 8px;
  }

  .product-price {
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .original-price {
    text-decoration: line-through;
    color: #999;
    font-size: 0.9rem;
  }

  .sale-price {
    color: #dc3545;
    font-size: 1.6rem;
    font-weight: 900;
  }

  .variant-selector {
    margin-bottom: 15px;
  }

  .variant-selector label {
    display: block;
    font-size: 0.9rem;
    font-weight: 600;
    color: #333;
    margin-bottom: 5px;
  }

  .variant-selector select {
    width: 100%;
    padding: 8px 12px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-size: 0.9rem;
    background: white;
    cursor: pointer;
  }

  .variant-selector select:focus {
    border-color: #0071ce;
    outline: none;
  }

  .quantity-controls {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 15px;
  }

  .quantity-controls label {
    font-size: 0.9rem;
    font-weight: 600;
    color: #333;
    min-width: 60px;
  }

  .quantity-input-wrapper {
    display: flex;
    align-items: center;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    overflow: hidden;
  }

  .quantity-btn {
    background: #f8f9fa;
    border: none;
    padding: 8px 12px;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 600;
    color: #0071ce;
    transition: background 0.2s ease;
  }

  .quantity-btn:hover {
    background: #e9ecef;
  }

  .quantity-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .quantity-input {
    border: none;
    padding: 8px 12px;
    width: 60px;
    text-align: center;
    font-size: 1rem;
    font-weight: 600;
  }

  .quantity-input:focus {
    outline: none;
  }

  .product-cta {
    background: #0071ce;
    color: white;
    padding: 12px 25px;
    border: none;
    border-radius: 25px;
    font-weight: 700;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
    display: inline-block;
    text-align: center;
    width: 100%;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .product-cta:hover {
    background: #005ba6;
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0, 113, 206, 0.4);
    color: white;
    text-decoration: none;
  }

  /* Mobile Responsive */
  @media (max-width: 768px) {
    .patriotic-sale-container {
      padding: 20px 10px;
    }

    .sale-header {
      padding: 25px 15px;
      flex-direction: column;
      text-align: center;
      min-height: auto;
      gap: 25px;
    }

    .hero-left {
      text-align: center;
      max-width: 100%;
    }

    .hero-right {
      flex: none;
      width: 100%;
      max-width: 350px;
      margin: 0 auto;
    }

    .products-grid {
      grid-template-columns: 1fr;
      gap: 20px;
      padding: 20px;
    }

    .collection-header {
      padding: 15px 20px;
      flex-direction: column;
      text-align: center;
      gap: 15px;
      min-height: auto;
    }

    .collection-title {
      font-size: 1.5rem;
    }
  }
</style>

<div class="patriotic-sale-container">
  <div class="sale-header">
    <div class="hero-left">
      <div class="independence-badge">US Independence Day Special</div>
      <h1>Our <span class="gradient-text">Biggest</span> Patriotic <span class="gradient-text">Sale</span> of the <span class="gradient-text">Year!</span></h1>
      <div class="discount">UP TO 25% OFF</div>
      <div class="sale-subtitle">
        Celebrate America's independence with our biggest sale of the year!
      </div>
      <a href="#products-section" class="shop-now-cta" onclick="scrollToProducts()">Shop Now & Save Big!</a>
    </div>

    <div class="hero-right">
      <div class="header-timer">
        <div class="header-timer-label">Sale Ends August 31st</div>
        <div class="header-countdown">
          <div class="header-countdown-unit">
            <span id="days">02</span>
            <label>Days</label>
          </div>
          <div class="header-countdown-unit">
            <span id="hours">06</span>
            <label>Hours</label>
          </div>
          <div class="header-countdown-unit">
            <span id="minutes">25</span>
            <label>Mins</label>
          </div>
          <div class="header-countdown-unit">
            <span id="seconds">41</span>
            <label>Secs</label>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="tabs-container" id="products-section">

    <!-- EZBio¬Æ Centrifuge Tube Assemblies Collection - 25% Off -->
    {% assign centrifuge_tube_collection = collections['ezbio-centrifuge-tube-assemblies-up-to-25-off'] %}
    {% if centrifuge_tube_collection.products.size > 0 %}
    <div class="collection-section" id="EZBio-Centrifuge-Tube-Assemblies">
      <div class="collection-header">
        <div class="collection-header-content">
          <h2 class="collection-title">EZBio¬Æ Centrifuge Tube Assemblies</h2>
        </div>
      </div>
      <div class="products-grid">
        {% for product in centrifuge_tube_collection.products %}
        <div class="product-card">
          <div class="discount-badge">
            <div class="discount-label">25% OFF</div>
          </div>
          <div class="product-image">
            {% if product.featured_image %}
              <img id="product-image-{{ product.id }}" src="{{ product.featured_image | img_url: '300x300' }}" alt="{{ product.title }}">
            {% else %}
              <div style="color: #6c757d; font-size: 1rem; text-align: center;">Product Image</div>
            {% endif %}
          </div>
          <div class="product-content">
            <h3 class="product-title">{{ product.title }}</h3>
            {% if product.variants.first.sku != blank %}
              <div class="product-sku" id="product-sku-{{ product.id }}">
                {{ product.variants.first.sku }}
              </div>
            {% endif %}

            {% if product.variants.size > 1 %}
            <div class="variant-selector">
              <label for="variant-select-{{ product.id }}">Options:</label>
              <select id="variant-select-{{ product.id }}" onchange="updateProductDetails({{ product.id }})">
                {% for variant in product.variants %}
                  <option value="{{ variant.id }}" 
                          data-price="{{ variant.price }}" 
                          data-sku="{{ variant.sku }}"
                          data-image="{% if variant.image %}{{ variant.image | img_url: '300x300' }}{% else %}{{ product.featured_image | img_url: '300x300' }}{% endif %}">
                    {{ variant.title }} - ${{ variant.price | money_without_currency }}
                  </option>
                {% endfor %}
              </select>
            </div>
            {% endif %}

            <div class="product-price">
              {% assign first_variant = product.variants.first %}
              {% assign discounted_price = first_variant.price | times: 0.75 %}
              {% if first_variant.compare_at_price and first_variant.compare_at_price > first_variant.price %}
                <span class="original-price">${{ first_variant.compare_at_price | money_without_currency }}</span>
              {% endif %}
              <span class="sale-price">${{ first_variant.price | money_without_currency }}</span>
              <span class="final-price" id="final-price-{{ product.id }}">${{ discounted_price | money_without_currency }}</span>
            </div>

            <div class="quantity-controls">
              <label>Qty:</label>
              <div class="quantity-input-wrapper">
                <button type="button" class="quantity-btn" onclick="decreaseQuantity({{ product.id }})">‚àí</button>
                <input type="number" class="quantity-input" id="quantity-{{ product.id }}" value="1" min="1" readonly>
                <button type="button" class="quantity-btn" onclick="increaseQuantity({{ product.id }})">+</button>
              </div>
            </div>

            <div class="product-buttons">
              <button class="product-cta add-to-cart-direct" onclick="addToCartDirect({{ product.id }})">Add to Cart</button>
              <button class="product-cta shop-now" onclick="openAddToCartPopupWithEvent(event, {{ product.id }}, '{{ product.title | escape }}', '{{ product.featured_image | img_url: '300x300' }}', '{{ product.variants.first.sku }}', {{ product.variants.first.price }}, {{ product.variants.first.id }}, {% if product.variants.first.compare_at_price %}{{ product.variants.first.compare_at_price }}{% else %}0{% endif %})">Shop Now</button>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <!-- EZBio¬Æ MTO Centrifuge Tube Assemblies Collection - 25% Off -->
    {% assign mto_centrifuge_collection = collections['ezbio-mto-centrifuge-tube-assemblies-up-to-25-off'] %}
    {% if mto_centrifuge_collection.products.size > 0 %}
    <div class="collection-section" id="EZBio-MTO-Centrifuge-Tube-Assemblies">
      <div class="collection-header">
        <div class="collection-header-content">
          <h2 class="collection-title">EZBio¬Æ MTO Centrifuge Tube Assemblies</h2>
        </div>
      </div>
      <div class="products-grid">
        {% for product in mto_centrifuge_collection.products %}
        <div class="product-card">
          <div class="discount-badge">
            <div class="discount-label">25% OFF</div>
          </div>
          <div class="product-image">
            {% if product.featured_image %}
              <img id="product-image-{{ product.id }}" src="{{ product.featured_image | img_url: '300x300' }}" alt="{{ product.title }}">
            {% else %}
              <div style="color: #6c757d; font-size: 1rem; text-align: center;">Product Image</div>
            {% endif %}
          </div>
          <div class="product-content">
            <h3 class="product-title">{{ product.title }}</h3>
            {% if product.variants.first.sku != blank %}
              <div class="product-sku" id="product-sku-{{ product.id }}">
                {{ product.variants.first.sku }}
              </div>
            {% endif %}

            {% if product.variants.size > 1 %}
            <div class="variant-selector">
              <label for="variant-select-{{ product.id }}">Options:</label>
              <select id="variant-select-{{ product.id }}" onchange="updateProductDetails({{ product.id }})">
                {% for variant in product.variants %}
                  <option value="{{ variant.id }}" 
                          data-price="{{ variant.price }}" 
                          data-sku="{{ variant.sku }}"
                          data-image="{% if variant.image %}{{ variant.image | img_url: '300x300' }}{% else %}{{ product.featured_image | img_url: '300x300' }}{% endif %}">
                    {{ variant.title }} - ${{ variant.price | money_without_currency }}
                  </option>
                {% endfor %}
              </select>
            </div>
            {% endif %}

            <div class="product-price">
              {% assign first_variant = product.variants.first %}
              {% assign discounted_price = first_variant.price | times: 0.75 %}
              {% if first_variant.compare_at_price and first_variant.compare_at_price > first_variant.price %}
                <span class="original-price">${{ first_variant.compare_at_price | money_without_currency }}</span>
              {% endif %}
              <span class="sale-price">${{ first_variant.price | money_without_currency }}</span>
              <span class="final-price" id="final-price-{{ product.id }}">${{ discounted_price | money_without_currency }}</span>
            </div>

            <div class="quantity-controls">
              <label>Qty:</label>
              <div class="quantity-input-wrapper">
                <button type="button" class="quantity-btn" onclick="decreaseQuantity({{ product.id }})">‚àí</button>
                <input type="number" class="quantity-input" id="quantity-{{ product.id }}" value="1" min="1" readonly>
                <button type="button" class="quantity-btn" onclick="increaseQuantity({{ product.id }})">+</button>
              </div>
            </div>

            <div class="product-buttons">
              <button class="product-cta add-to-cart-direct" onclick="addToCartDirect({{ product.id }})">Add to Cart</button>
              <button class="product-cta shop-now" onclick="openAddToCartPopupWithEvent(event, {{ product.id }}, '{{ product.title | escape }}', '{{ product.featured_image | img_url: '300x300' }}', '{{ product.variants.first.sku }}', {{ product.variants.first.price }}, {{ product.variants.first.id }}, {% if product.variants.first.compare_at_price %}{{ product.variants.first.compare_at_price }}{% else %}0{% endif %})">Shop Now</button>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

  </div>
</div>

<script>
// Countdown Timer
function updateCountdown() {
  // Set the date we're counting down to (August 31st, 2025 at 11:59 PM)
  const countDownDate = new Date('2025-08-31T23:59:59').getTime();

  const timer = setInterval(function() {
    const now = new Date().getTime();
    const distance = countDownDate - now;

    const days = Math.floor(distance / (1000 * 60 * 60 * 24));
    const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((distance % (1000 * 60)) / 1000);

    const dayStr = String(days).padStart(2, '0');
    const hourStr = String(hours).padStart(2, '0');
    const minuteStr = String(minutes).padStart(2, '0');
    const secondStr = String(seconds).padStart(2, '0');

    const daysEl = document.getElementById("days");
    const hoursEl = document.getElementById("hours");
    const minutesEl = document.getElementById("minutes");
    const secondsEl = document.getElementById("seconds");

    if (daysEl) daysEl.innerHTML = dayStr;
    if (hoursEl) hoursEl.innerHTML = hourStr;
    if (minutesEl) minutesEl.innerHTML = minuteStr;
    if (secondsEl) secondsEl.innerHTML = secondStr;

    if (distance < 0) {
      clearInterval(timer);
      ["days", "hours", "minutes", "seconds"].forEach(id => {
        const element = document.getElementById(id);
        if (element) element.innerHTML = "00";
      });
    }
  }, 1000);
}

// Scroll to products function
function scrollToProducts() {
  const productsSection = document.getElementById('products-section');
  if (productsSection) {
    productsSection.scrollIntoView({ 
      behavior: 'smooth',
      block: 'start'
    });
  }
}

// Update product details when variant changes
function updateProductDetails(productId) {
  const variantSelect = document.getElementById(`variant-select-${productId}`);
  const selectedOption = variantSelect.options[variantSelect.selectedIndex];

  const price = parseFloat(selectedOption.dataset.price);
  const sku = selectedOption.dataset.sku;
  const image = selectedOption.dataset.image;

  // Update price with 25% discount
  const discountedPrice = price * 0.75;
  const salePriceElement = document.getElementById(`sale-price-${productId}`);
  if (salePriceElement) {
    salePriceElement.textContent = `$${(discountedPrice / 100).toFixed(2)}`;
  }

  // Update SKU
  const skuElement = document.getElementById(`product-sku-${productId}`);
  if (skuElement && sku) {
    skuElement.textContent = sku;
  }

  // Update image
  const imageElement = document.getElementById(`product-image-${productId}`);
  if (imageElement && image) {
    imageElement.src = image;
  }
}

// Quantity controls
function increaseQuantity(productId) {
  const quantityInput = document.getElementById(`quantity-${productId}`);
  const currentValue = parseInt(quantityInput.value);
  quantityInput.value = currentValue + 1;
}

function decreaseQuantity(productId) {
  const quantityInput = document.getElementById(`quantity-${productId}`);
  const currentValue = parseInt(quantityInput.value);
  if (currentValue > 1) {
    quantityInput.value = currentValue - 1;
  }
}

// Add to cart function
function addToCart(productId) {
  const variantSelect = document.getElementById(`variant-select-${productId}`);
  const quantityInput = document.getElementById(`quantity-${productId}`);

  let variantId;
  if (variantSelect) {
    variantId = variantSelect.value;
  } else {
    // If no variant selector, get the first variant ID from the product card
    const productCard = document.querySelector(`#variant-select-${productId}`);
    if (!productCard) {
      // Fallback: construct variant ID from product ID (this may need adjustment based on your setup)
      console.warn('No variant selector found for product', productId);
      return;
    }
  }

  const quantity = parseInt(quantityInput.value);

  // Add to cart via AJAX
  fetch('/cart/add.js', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      id: variantId,
      quantity: quantity
    })
  })
  .then(response => response.json())
  .then(data => {
    // Show success message
    alert('Product added to cart successfully!');
    // Optionally redirect to cart or update cart count
    // window.location.href = '/cart';
  })
  .catch(error => {
    console.error('Error adding to cart:', error);
    alert('Error adding product to cart. Please try again.');
  });
}

// Start countdown when page loads
document.addEventListener('DOMContentLoaded', function() {
  updateCountdown();
});
</script>
<script>

// Countdown Timer
// Global function for opening popup with event handling
function openAddToCartPopupWithEvent(event, productId, productTitle, productImage, productSKU, productPrice, productVariantId, compareAtPrice) {
    event.stopPropagation();
    openAddToCartPopup(productId, productTitle, productImage, productSKU, productPrice, productVariantId, compareAtPrice, event);
}

function updateCountdown() {
  // Set the date we're counting down to (July 31st, 2024 at 11:59 PM)
  const countDownDate = new Date('2025-07-31T23:59:59').getTime();

  const timer = setInterval(function() {
    const now = new Date().getTime();
    const distance = countDownDate - now;

    const days = Math.floor(distance / (1000 * 60 * 60 * 24));
    const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((distance % (1000 * 60)) / 1000);

    const dayStr = String(days).padStart(2, '0');
    const hourStr = String(hours).padStart(2, '0');
    const minuteStr = String(minutes).padStart(2, '0');
    const secondStr = String(seconds).padStart(2, '0');

    // Update main timer
    const daysEl = document.getElementById("days");
    const hoursEl = document.getElementById("hours");
    const minutesEl = document.getElementById("minutes");
    const secondsEl = document.getElementById("seconds");

    if (daysEl) daysEl.innerHTML = dayStr;
    if (hoursEl) hoursEl.innerHTML = hourStr;
    if (minutesEl) minutesEl.innerHTML = minuteStr;
    if (secondsEl) secondsEl.innerHTML = secondStr;

    // Update sticky timer
    const stickyDaysEl = document.getElementById("sticky-days");
    const stickyHoursEl = document.getElementById("sticky-hours");
    const stickyMinutesEl = document.getElementById("sticky-minutes");
    const stickySecondsEl = document.getElementById("sticky-seconds");

    if (stickyDaysEl) stickyDaysEl.innerHTML = dayStr;
    if (stickyHoursEl) stickyHoursEl.innerHTML = hourStr;
    if (stickyMinutesEl) stickyMinutesEl.innerHTML = minuteStr;
    if (stickySecondsEl) stickySecondsEl.innerHTML = secondStr;

    if (distance < 0) {
      clearInterval(timer);
      // Reset both timers
      ["days", "hours", "minutes", "seconds", "sticky-days", "sticky-hours", "sticky-minutes", "sticky-seconds"].forEach(id => {
        const element = document.getElementById(id);
        if (element) element.innerHTML = "00";
      });
    }
  }, 1000);
}

// Scroll to products function
function scrollToProducts() {
  const productsSection = document.getElementById('products-section');
  if (productsSection) {
    productsSection.scrollIntoView({ 
      behavior: 'smooth',
      block: 'start'
    });
  }
}

// Calculate final prices and smart savings
function calculatePricesAndSavings() {
  // Calculate final prices based on discount percentage from the actual discount label
  const finalPrices = document.querySelectorAll('.final-price');
  finalPrices.forEach(finalPrice => {
    const salePrice = parseFloat(finalPrice.dataset.salePrice.replace(/,/g, ''));

    // Get the actual discount percentage from the discount label in the same product card
    const productCard = finalPrice.closest('.product-card');
    const discountLabel = productCard.querySelector('.discount-label');
    const discountText = discountLabel.textContent;
    const actualDiscountPercentage = parseInt(discountText.replace(/[^\d]/g, ''));

    const finalPriceAmount = salePrice - (salePrice * actualDiscountPercentage / 100);

    // Format price consistently with 2 decimal places
    finalPrice.textContent = '$' + finalPriceAmount.toFixed(2);
  });

  // Calculate smart savings amounts for expanded sections
  const savingsAmounts = document.querySelectorAll('.savings-amount');
  savingsAmounts.forEach(savingsAmount => {
    const basePrice = parseFloat(savingsAmount.dataset.basePrice.replace(/,/g, ''));
    const qty = parseInt(savingsAmount.dataset.qty);

    // Find the discount percentage from the product card's discount badge
    const productCard = savingsAmount.closest('.product-card');
    const discountLabel = productCard.querySelector('.discount-label');
    const discountText = discountLabel.textContent;
    const discountPercentage = parseInt(discountText.replace(/[^\d]/g, ''));
    const discountRate = discountPercentage / 100;

    const regularTotal = basePrice * qty;
    const discountedTotal = regularTotal * (1 - discountRate);
    const totalSavings = regularTotal - discountedTotal;
    const perItemSavings = totalSavings / qty;

    savingsAmount.textContent = perItemSavings.toFixed(2);
  });

  // Calculate smart savings preview amounts - must match the savings amounts
  const savingsPreviewAmounts = document.querySelectorAll('.savings-preview-amount');
  savingsPreviewAmounts.forEach(savingsPreviewAmount => {
    const basePrice = parseFloat(savingsPreviewAmount.dataset.basePrice.replace(/,/g, ''));
    const qty = parseInt(savingsPreviewAmount.dataset.qty);

    // Find the discount percentage from the product card's discount badge
    const productCard = savingsPreviewAmount.closest('.product-card');
    const discountLabel = productCard.querySelector('.discount-label');
    const discountText = discountLabel.textContent;
    const discountPercentage = parseInt(discountText.replace(/[^\d]/g, ''));
    const discountRate = discountPercentage / 100;

    const regularTotal = basePrice * qty;
    const discountedTotal = regularTotal * (1 - discountRate);
    const totalSavings = regularTotal - discountedTotal;
    const perItemSavings = totalSavings / qty;

    savingsPreviewAmount.textContent = perItemSavings.toFixed(2);
  });
}

function toggleSavings(event, element) {
  // Prevent navigation to product page
  event.stopPropagation();
  element.classList.toggle('expanded');
}
 function copyToClipboard(text, event) {
    event.stopPropagation();
    navigator.clipboard.writeText(text)
        .then(() => {
            // Show toast notification
            const toast = document.createElement('div');
            toast.classList.add('toast');
            toast.textContent = text + ' SKU copied!';
            document.body.appendChild(toast);
            // Animate toast
            setTimeout(() => {
                toast.classList.add('show');
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => {
                        if (document.body.contains(toast)) {
                            document.body.removeChild(toast);
                        }
                    }, 300); // Duration of fade-out
                }, 2000); // Display duration
            }, 100); // Small delay before fade-in
        })
        .catch(err => {
            console.error('Could not copy text: ', err);
            // Fallback toast for error
            const errorToast = document.createElement('div');
            errorToast.classList.add('toast');
            errorToast.textContent = 'Failed to copy SKU. Please try again.';
            errorToast.style.background = '#dc3545';
            document.body.appendChild(errorToast);
            setTimeout(() => {
                errorToast.classList.add('show');
                setTimeout(() => {
                    errorToast.classList.remove('show');
                    setTimeout(() => {
                        if (document.body.contains(errorToast)) {
                            document.body.removeChild(errorToast);
                        }
                    }, 300);
                }, 2000);
            }, 100);
        });
}


// Add to cart functionality with popup
let selectedProductId;
let selectedProductTitle;
let selectedProductImage;
let selectedProductSKU;
let selectedProductPrice;
let selectedProductVariantId;
let selectedProductCompareAtPrice;
let selectedProductDiscount;


function openAddToCartPopup(productId, productTitle, productImage, productSKU, productPrice, productVariantId, compareAtPrice, event) {
    selectedProductId = productId;
    selectedProductTitle = productTitle;
    selectedProductImage = productImage;
    selectedProductSKU = productSKU;
    selectedProductPrice = productPrice;
    selectedProductVariantId = productVariantId;
    selectedProductCompareAtPrice = compareAtPrice;

    // Find the product card to get discount information by using the event target
    const productCard = event.target.closest('.product-card');
    let discountPercentage = 0;
    let finalPrice = productPrice;

    if (productCard) {
        const discountLabel = productCard.querySelector('.discount-label');
        if (discountLabel) {
            const discountText = discountLabel.textContent;
            discountPercentage = parseInt(discountText.replace(/[^\d]/g, '')) || 0;

            // Calculate final price properly
            if (discountPercentage > 0) {
                finalPrice = productPrice * (1 - discountPercentage / 100);
            }
        }
    }

    selectedProductDiscount = discountPercentage;

    // Helper function to format price
    function formatPrice(price) {
        const priceInNumber = Number(price);
        // Always show 2 decimal places for consistency
        return priceInNumber.toFixed(2);
    }

    // Populate popup content
    const popupImageEl = document.getElementById('popupProductImage');
    const popupTitleEl = document.getElementById('popupProductTitle');
    const popupSKUEl = document.getElementById('popupProductSKU');

    if (popupImageEl) popupImageEl.src = productImage;
    if (popupTitleEl) popupTitleEl.textContent = productTitle;
    if (popupSKUEl) popupSKUEl.textContent = productSKU;

    // Add the original price to the popup
    const originalPriceElement = document.getElementById('popupOriginalPrice');
    if (selectedProductCompareAtPrice > 0){
        originalPriceElement.textContent = '$' + formatPrice(selectedProductCompareAtPrice / 100); // original price
        originalPriceElement.style.display = 'inline';
    }else {
        originalPriceElement.style.display = 'none';
    }

    const popupSalePriceEl = document.getElementById('popupSalePrice');
    const popupFinalPriceEl = document.getElementById('popupFinalPrice');
    const popupQuantityEl = document.getElementById('popupQuantity');

    if (popupSalePriceEl) popupSalePriceEl.textContent = formatPrice(productPrice / 100);
    if (popupFinalPriceEl) popupFinalPriceEl.textContent = '$' + formatPrice(finalPrice / 100);
    if (popupQuantityEl) popupQuantityEl.value = 1;

    // Show discount badge with the SAME percentage as the product card
    const discountBadge = document.getElementById('popupDiscountBadge');
    if (discountPercentage > 0) {
        discountBadge.textContent = discountPercentage + '% OFF';
        discountBadge.style.display = 'block';
    } else {
        discountBadge.style.display = 'none';
    }

  // Calculate smart savings for different quantities using the SAME logic as product cards
  const priceInDollars = productPrice / 100;

  // Calculate for 2+ items
  const qty2 = 2;
  const regularTotal2 = priceInDollars * qty2;
  const discountedTotal2 = regularTotal2 * (1 - discountPercentage / 100);
  const totalSavings2 = regularTotal2 - discountedTotal2;
  const perItemSavings2 = totalSavings2 / qty2;

  // Calculate for 3+ items - FIXED: Use correct quantity multiplier
  const qty3 = 3;
  const bulkDiscount3 = discountPercentage + 5; // Additional 5% bulk discount for 3+ items
  const regularTotal3 = priceInDollars * qty3;
  const discountedTotal3 = regularTotal3 * (1 - bulkDiscount3 / 100);
  const totalSavings3 = regularTotal3 - discountedTotal3;
  const perItemSavings3 = totalSavings3 / qty3;

  // Calculate for 5+ items - FIXED: Use correct quantity multiplier
  const qty5 = 5;
  const bulkDiscount5 = discountPercentage + 10; // Additional 10% bulk discount for 5+ items
  const regularTotal5 = priceInDollars * qty5;
  const discountedTotal5 = regularTotal5 * (1 - bulkDiscount5 / 100);
  const totalSavings5 = regularTotal5 - discountedTotal5;
  const perItemSavings5 = totalSavings5 / qty5;

    const popupSavingsPreviewEl = document.getElementById('popupSavingsPreview');
    const popupSavingsAmount2El = document.getElementById('popupSavingsAmount2');
    const popupSavingsAmount3El = document.getElementById('popupSavingsAmount3');
    const popupSavingsAmount5El = document.getElementById('popupSavingsAmount5');

    if (popupSavingsPreviewEl) popupSavingsPreviewEl.textContent = formatPrice(perItemSavings2);
    if (popupSavingsAmount2El) popupSavingsAmount2El.textContent = formatPrice(perItemSavings2);
    if (popupSavingsAmount3El) popupSavingsAmount3El.textContent = formatPrice(perItemSavings3);
    if (popupSavingsAmount5El) popupSavingsAmount5El.textContent = formatPrice(perItemSavings5);

    // Reset savings selections
    document.querySelectorAll('.popup-savings-option').forEach(option => {
        option.classList.remove('selected');
    });

    // Show overlay first
    const overlay = document.getElementById('overlay');
    const popup = document.getElementById('addToCartPopup');

    overlay.classList.add('show');

    // Small delay for smooth animation
    setTimeout(() => {
        popup.classList.add('show');
    }, 10);

    // Prevent body scroll
    document.body.style.overflow = 'hidden';

    // Ensure Add to Cart button is visible
    const addToCartBtn = document.querySelector('.popup-add-to-cart');
    if (addToCartBtn) {
        addToCartBtn.style.display = 'block';
    }

    // Load current cart info first
    updateCartInfo();

    // Show related products in left column on desktop only if cart has items
    setTimeout(() => {
        if (currentCartCount > 0 && window.innerWidth >= 768) {
            updateLeftColumnRelatedProducts();
        }
    }, 500);
}

function closeAddToCartPopup() {
    const overlay = document.getElementById('overlay');
    const popup = document.getElementById('addToCartPopup');

    popup.classList.remove('show');

    setTimeout(() => {
        overlay.classList.remove('show');
        document.body.style.overflow = '';

        // Clean up any dynamically created checkout sections
        const checkoutSection = document.querySelector('.popup-checkout-section');
        if (checkoutSection) {
            checkoutSection.remove();
        }
    }, 300);
}

function increaseQuantity() {
    const quantityInput = document.getElementById('popupQuantity');
    const currentValue = parseInt(quantityInput.value);
    quantityInput.value = currentValue + 1;
}

function decreaseQuantity() {
    const quantityInput = document.getElementById('popupQuantity');
    const currentValue = parseInt(quantityInput.value);
    if (currentValue > 1) {
        quantityInput.value = currentValue - 1;
    }
}

function togglePopupSavings(element) {
    element.classList.toggle('expanded');
}

function selectSavingsOption(quantity) {
    // Remove selected class from all options
    document.querySelectorAll('.popup-savings-option').forEach(option => {
        option.classList.remove('selected');
    });

    // Add selected class to clicked option
    document.querySelector(`.popup-savings-${quantity}`).classList.add('selected');

    // Update quantity input
    document.getElementById('popupQuantity').value = quantity;

    // Don't auto-add to cart - let user click Add to Cart button
    // This gives users more control over their purchase
}

function addToCart() {
    const quantity = document.getElementById('popupQuantity').value;

    // Add to cart via AJAX instead of redirect
    fetch('/cart/add.js', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            id: selectedProductVariantId,
            quantity: parseInt(quantity)
        })
    })
    .then(response => response.json())
    .then(data => {
        // Show success notification
        showAddToCartSuccess();

        // Update header cart count immediately
        updateHeaderCartCount();

        // Check for automatic coupon codes after adding to cart
        setTimeout(() => {
            checkForAutomaticCoupons();
        }, 1000);

        // Update cart count and show checkout section now that cart has items
        updateCartInfo();

        // Reset quantity to 1 after adding
        document.getElementById('popupQuantity').value = 1;

        // Keep the Add to Cart button visible alongside checkout options
        const addToCartBtn = document.querySelector('.popup-add-to-cart');
        if (addToCartBtn) {
            addToCartBtn.style.display = 'block';
        }
    })
    .catch(error => {
        console.error('Error adding to cart:', error);
        showAddToCartError();
    });
}

function checkForAutomaticCoupons() {
    // Fetch current cart to check if automatic coupons were applied
    fetch('/cart.js')
    .then(response => response.json())
    .then(cart => {
        // Update current cart total
        currentCartTotal = cart.total_price;
        currentCartCount = cart.item_count;

        // Check if there are any discounts applied
        if (cart.discounts && cart.discounts.length > 0) {
            // Show notification about automatic discount
            showAutomaticCouponNotification(cart.discounts);
        }

        // Update checkout button status
        updateCartInfo();
    })
    .catch(error => {
        console.error('Error checking for automatic coupons:', error);
    });
}

function showAutomaticCouponNotification(discounts) {
    const notification = document.createElement('div');
    notification.classList.add('cart-notification', 'success', 'coupon-notification');

    const discountNames = discounts.map(d => d.title).join(', ');
    const totalSavings = discounts.reduce((sum, d) => sum + (d.amount || 0), 0);

    notification.innerHTML = `
        <div class="notification-content">
            <span class="notification-icon">üéâ</span>
            <div class="notification-text">
                <strong>Automatic Discount Applied!</strong><br>
                ${discountNames} - Save $${(totalSavings / 100).toFixed(2)}
            </div>
        </div>
    `;
    document.body.appendChild(notification);

    setTimeout(() => {
        notification.classList.add('show');
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    document.body.removeChild(notification);
                }
            }, 300);
        }, 4000); // Show longer for coupon notifications
    }, 100);
}

function showAddToCartSuccess() {
    // Create and show success notification
    const notification = document.createElement('div');
    notification.classList.add('cart-notification', 'success');
    notification.innerHTML = `
        <div class="notification-content">
            <span class="notification-icon">‚úì</span>
            <span class="notification-text">Product added to cart successfully!</span>
        </div>
    `;
    document.body.appendChild(notification);

    setTimeout(() => {
        notification.classList.add('show');
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    document.body.removeChild(notification);
                }
            }, 300);
        }, 3000);
    }, 100);
}

function showAddToCartError() {
    const notification = document.createElement('div');
    notification.classList.add('cart-notification', 'error');
    notification.innerHTML = `
        <div class="notification-content">
            <span class="notification-icon">‚úó</span>
            <span class="notification-text">Failed to add product to cart. Please try again.</span>
        </div>
    `;
    document.body.appendChild(notification);

    setTimeout(() => {
        notification.classList.add('show');
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    document.body.removeChild(notification);
                }
            }, 300);
        }, 3000);
    }, 100);
}

// Global cart info
let currentCartCount = 0;
let currentCartTotal = 0;
const MINIMUM_ORDER_VALUE = 10000; // $100 in cents

function updateHeaderCartCount() {
    // Update the header cart count
    fetch('/cart.js')
    .then(response => response.json())
    .then(cart => {
        const headerCartCount = document.querySelector('.cart-count');
        if (headerCartCount) {
            headerCartCount.textContent = cart.item_count;
        }
    })
    .catch(error => {
        console.error('Error updating header cart count:', error);
    });
}

function updateCartInfo() {
    // Fetch current cart information
    fetch('/cart.js')
    .then(response => response.json())
    .then(cart => {
        currentCartCount = cart.item_count;
        currentCartTotal = cart.total_price;

        // Only update checkout button if there are items in cart
        if (currentCartCount > 0) {
            updateCheckoutButton();
        } else {
            // Remove checkout section if cart is empty
            const checkoutSection = document.querySelector('.popup-checkout-section');
            if (checkoutSection) {
                checkoutSection.remove();
            }
        }
    })
    .catch(error => {
        console.error('Error fetching cart:', error);
    });
}

function updateCheckoutButton() {
    // Create or update checkout section if it doesn't exist
    let checkoutSection = document.querySelector('.popup-checkout-section');
    const addToCartButton = document.querySelector('.popup-add-to-cart');

    if (!checkoutSection) {
        checkoutSection = document.createElement('div');
        checkoutSection.classList.add('popup-checkout-section');

        // Insert after the add to cart button
        addToCartButton.parentNode.insertBefore(checkoutSection, addToCartButton.nextSibling);
    }

    // Add sticky behavior when cart has items
    if (currentCartCount > 0) {
        checkoutSection.classList.add('sticky-active');
        addToCartButton.classList.add('sticky-active');
    } else {
        checkoutSection.classList.remove('sticky-active');
        addToCartButton.classList.remove('sticky-active');
    }

    // Check if cart meets minimum order value
    const meetsMinimum = currentCartTotal >= MINIMUM_ORDER_VALUE;
    const remaining = MINIMUM_ORDER_VALUE - currentCartTotal;

    // Get actual products from the page (excluding current product) - only show if cart has items and on mobile
    let relatedProductsHTML = '';
    if (currentCartCount > 0 && window.innerWidth < 768) {
        const relatedProducts = getRelatedProducts(); // Get all available products

        if (relatedProducts.length > 0) {
            relatedProductsHTML = `
                <div class="related-products-section">
                    <h3>üí° You might also like</h3>
                    <div class="related-products-grid">
                        ${relatedProducts.map(product => `
                            <div class="related-product-card" onclick="openRelatedProduct('${product.id}', '${product.title.replace(/'/g, "\\'")}', '${product.image}', '${product.sku}', ${product.price}, ${product.variantId})">
                                <div class="related-product-image">
                                    <img src="${product.image}" alt="${product.title}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                    <div class="related-placeholder" style="display: none;">üì¶</div>
                                </div>
                                <div class="related-product-info">
                                    <h4>${product.title}</h4>
                                    <div class="related-product-price">
                                        <span class="related-sale-price">$${(product.price / 100).toFixed(2)}</span>
                                        <span class="related-final-price">$${(product.finalPrice / 100).toFixed(2)}</span>
                                    </div>
                                    <div class="related-discount-badge">${product.discount}% OFF</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        } else if (window.innerWidth < 768) {
            relatedProductsHTML = `
                <div class="related-products-section">
                    <h3>üí° You might also like</h3>
                    <p style="text-align: center; color: #666; font-size: 12px; margin: 0;">Browse more products on this page</p>
                </div>
            `;
        }
    }

    // Create validation warning if minimum not met
    let validationHTML = '';
    if (!meetsMinimum) {
        validationHTML = `
            <div class="popup-validation-warning">
                <div class="validation-icon">‚ö†Ô∏è</div>
                <div class="validation-content">
                    <p class="validation-title">Minimum Order Required</p>
                    <p class="validation-message">
                        Add <strong>$${(remaining / 100).toFixed(2)}</strong> more to reach the minimum order value of <strong>$${(MINIMUM_ORDER_VALUE / 100).toFixed(2)}</strong>
                    </p>
                </div>
            </div>
        `;
    }

    const cartText = meetsMinimum 
        ? `üõí Checkout (${currentCartCount} items - $${(currentCartTotal / 100).toFixed(2)})` 
        : `üîí Minimum Order Required`;

    checkoutSection.innerHTML = `
        ${validationHTML}
        <div class="checkout-buttons">
            <button class="checkout-btn ${meetsMinimum ? 'primary' : 'disabled'}" onclick="proceedToCheckout()" ${!meetsMinimum ? 'disabled' : ''}>
                <span class="checkout-icon"></span>
                ${cartText}
            </button>
            <button class="checkout-btn secondary" onclick="continueShopping()">
                Continue Shopping
            </button>
        </div>
        ${relatedProductsHTML}
    `;
}

function getRelatedProducts(count = null) {
    const allProductCards = document.querySelectorAll('.product-card');
    const relatedProducts = [];

    // Get all available products that are not the current one
    const availableProducts = Array.from(allProductCards).filter(card => {
        const cardSku = card.querySelector('.product-sku')?.textContent.trim();
        return cardSku && cardSku !== selectedProductSKU;
    });

    // Shuffle and take specified count (or all if count is null)
    const shuffled = availableProducts.sort(() => 0.5 - Math.random());
    const selectedCards = count ? shuffled.slice(0, count) : shuffled;

    selectedCards.forEach(card => {
        const title = card.querySelector('.product-title')?.textContent.trim();
        const sku = card.querySelector('.product-sku')?.textContent.trim();
        const image = card.querySelector('.product-image img')?.src;
        const salePrice = card.querySelector('.sale-price')?.textContent.replace('$', '').replace(/,/g, '');
        const finalPrice = card.querySelector('.final-price')?.textContent.replace('$', '').replace(/,/g, '');
        const discountLabel = card.querySelector('.discount-label')?.textContent;
        const discount = discountLabel ? parseInt(discountLabel.replace(/[^\d]/g, '')) : 0;

        // Get product ID and variant ID from the Shop Now button
        const shopButton = card.querySelector('.product-cta');
        const onclickAttr = shopButton?.getAttribute('onclick');
        let productId = null;
        let variantId = null;

        if (onclickAttr) {
            const matches = onclickAttr.match(/openAddToCartPopupWithEvent\([^,]+,\s*(\d+),.*?,.*?,.*?,.*?,\s*(\d+)\)/);
            if (matches) {
                productId = matches[1];
                variantId = matches[2];
            }
        }

        if (title && sku && image && salePrice && finalPrice && productId && variantId) {
            const salePriceNum = parseFloat(salePrice.replace(/,/g, '')) || 0;
            const finalPriceNum = parseFloat(finalPrice.replace(/,/g, '')) || 0;

            relatedProducts.push({
                id: productId,
                title: title,
                sku: sku,
                image: image,
                price: Math.round(salePriceNum * 100), // Convert to cents
                finalPrice: Math.round(finalPriceNum * 100), // Convert to cents
                discount: discount,
                variantId: variantId
            });
        }
    });

    return relatedProducts;
}

function updateLeftColumnRelatedProducts() {
    const leftRelatedSection = document.getElementById('leftRelatedProducts');
    const leftRelatedGrid = document.getElementById('leftRelatedProductsGrid');

    if (leftRelatedSection && leftRelatedGrid) {
        // Only show if cart has items and on desktop
        if (currentCartCount === 0 || window.innerWidth < 768) {
            leftRelatedSection.style.display = 'none';
            return;
        }

        const relatedProducts = getRelatedProducts(8); // Get up to 8 products for left column

        if (relatedProducts.length > 0) {
            leftRelatedGrid.innerHTML = relatedProducts.map(product => `
                <div class="left-related-product-card" onclick="openRelatedProduct('${product.id}', '${product.title.replace(/'/g, "\\'")}', '${product.image}', '${product.sku}', ${product.price}, ${product.variantId})">
                    <div class="left-related-product-image">
                        <img src="${product.image}" alt="${product.title}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="related-placeholder" style="display: none;">üì¶</div>
                    </div>
                    <div class="left-related-product-info">
                        <h4>${product.title}</h4>
                        <div class="left-related-product-price">
                            <span class="left-related-sale-price">$${(product.price / 100).toFixed(2)}</span>
                            <span class="left-related-final-price">$${(product.finalPrice / 100).toFixed(2)}</span>
                        </div>
                        <div class="left-related-discount-badge">${product.discount}% OFF</div>
                    </div>
                </div>
            `).join('');
            leftRelatedSection.style.display = 'block';
        } else {
            leftRelatedSection.style.display = 'none';
        }
    }
}

function updateRelatedProducts() {
    // Update the related products section with new recommendations
    const relatedProductsSection = document.querySelector('.related-products-section');
    if (relatedProductsSection) {
        const relatedProducts = getRelatedProducts(); // Get all available products
        const relatedProductsGrid = relatedProductsSection.querySelector('.related-products-grid');

        if (relatedProductsGrid && relatedProducts.length > 0) {
            relatedProductsGrid.innerHTML = relatedProducts.map(product => `
                <div class="related-product-card" onclick="openRelatedProduct('${product.id}', '${product.title.replace(/'/g, "\\'")}', '${product.image}', '${product.sku}', ${product.price}, ${product.variantId})">
                    <div class="related-product-image">
                        <img src="${product.image}" alt="${product.title}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                        <div class="related-placeholder" style="display: none;">üì¶</div>
                    </div>
                    <div class="related-product-info">
                        <h4>${product.title}</h4>
                        <div class="related-product-price">
                            <span class="related-sale-price">$${(product.price / 100).toFixed(2)}</span>
                            <span class="related-final-price">$${(product.finalPrice / 100).toFixed(2)}</span>
                        </div>
                        <div class="related-discount-badge">${product.discount}% OFF</div>
                    </div>
                </div>
            `).join('');
        }
    }
}

function openRelatedProduct(productId, productTitle, productImage, productSKU, productPrice, productVariantId) {
    // Don't close the popup - just update the content directly
    // Find the product card to get discount and compare at price information
    const productCards = document.querySelectorAll('.product-card');
    let compareAtPrice = 0;
    let productCard = null;

    // Find the matching product card by SKU
    for (const card of productCards) {
        const cardSku = card.querySelector('.product-sku')?.textContent.trim();
        if (cardSku === productSKU) {
            productCard = card;
            // Get compare at price from original price if it exists
            const originalPriceEl = card.querySelector('.original-price');
            if (originalPriceEl) {
                const originalPriceText = originalPriceEl.textContent.replace('$', '').replace(/,/g, '');
                compareAtPrice = Math.round(parseFloat(originalPriceText) * 100);
            }
            break;
        }
    }

    // Create a fake event object with the found product card
    const fakeEvent = {
        target: productCard || document.querySelector(`[onclick*="${productId}"]`),
        stopPropagation: () => {}
    };

    // Update the popup content with new product data
    selectedProductId = productId;
    selectedProductTitle = productTitle;
    selectedProductImage = productImage;
    selectedProductSKU = productSKU;
    selectedProductPrice = productPrice;
    selectedProductVariantId = productVariantId;
    selectedProductCompareAtPrice = compareAtPrice;

    // Find discount information from the product card
    let discountPercentage = 0;
    let finalPrice = productPrice;

    if (productCard) {
        const discountLabel = productCard.querySelector('.discount-label');
        if (discountLabel) {
            const discountText = discountLabel.textContent;
            discountPercentage = parseInt(discountText.replace(/[^\d]/g, '')) || 0;

            // Calculate final price properly
            if (discountPercentage > 0) {
                finalPrice = productPrice * (1 - discountPercentage / 100);
            }
        }
    }

    selectedProductDiscount = discountPercentage;

    // Helper function to format price
    function formatPrice(price) {
        const priceInNumber = Number(price);
        return priceInNumber.toFixed(2);
    }

    // Update popup content immediately
    const popupImageEl = document.getElementById('popupProductImage');
    const popupTitleEl = document.getElementById('popupProductTitle');
    const popupSKUEl = document.getElementById('popupProductSKU');

    if (popupImageEl) popupImageEl.src = productImage;
    if (popupTitleEl) popupTitleEl.textContent = productTitle;
    if (popupSKUEl) popupSKUEl.textContent = productSKU;

    // Update original price in the popup
    const originalPriceElement = document.getElementById('popupOriginalPrice');
    if (selectedProductCompareAtPrice > 0){
        originalPriceElement.textContent = '$' + formatPrice(selectedProductCompareAtPrice / 100);
        originalPriceElement.style.display = 'inline';
    } else {
        originalPriceElement.style.display = 'none';
    }

    const popupSalePriceEl = document.getElementById('popupSalePrice');
    const popupFinalPriceEl = document.getElementById('popupFinalPrice');
    const popupQuantityEl = document.getElementById('popupQuantity');

    if (popupSalePriceEl) popupSalePriceEl.textContent = formatPrice(productPrice / 100);
    if (popupFinalPriceEl) popupFinalPriceEl.textContent = '$' + formatPrice(finalPrice / 100);
    if (popupQuantityEl) popupQuantityEl.value = 1;

    // Show discount badge with the SAME percentage as the product card
    const discountBadge = document.getElementById('popupDiscountBadge');
    if (discountPercentage > 0) {
        discountBadge.textContent = discountPercentage + '% OFF';
        discountBadge.style.display = 'block';
    } else {
        discountBadge.style.display = 'none';
    }

    // Calculate smart savings for different quantities
    const priceInDollars = productPrice / 100;

    // Calculate for 2+ items
    const qty2 = 2;
    const regularTotal2 = priceInDollars * qty2;
    const discountedTotal2 = regularTotal2 * (1 - discountPercentage / 100);
    const totalSavings2 = regularTotal2 - discountedTotal2;
    const perItemSavings2 = totalSavings2 / qty2;

    // Calculate for 3+ items
    const qty3 = 3;
    const bulkDiscount3 = discountPercentage + 5;
    const regularTotal3 = priceInDollars * qty3;
    const discountedTotal3 = regularTotal3 * (1 - bulkDiscount3 / 100);
    const totalSavings3 = regularTotal3 - discountedTotal3;
    const perItemSavings3 = totalSavings3 / qty3;

    // Calculate for 5+ items
    const qty5 = 5;
    const bulkDiscount5 = discountPercentage + 10;
    const regularTotal5 = priceInDollars * qty5;
    const discountedTotal5 = regularTotal5 * (1 - bulkDiscount5 / 100);
    const totalSavings5 = regularTotal5 - discountedTotal5;
    const perItemSavings5 = totalSavings5 / qty5;

    const popupSavingsPreviewEl = document.getElementById('popupSavingsPreview');
    const popupSavingsAmount2El = document.getElementById('popupSavingsAmount2');
    const popupSavingsAmount3El = document.getElementById('popupSavingsAmount3');
    const popupSavingsAmount5El = document.getElementById('popupSavingsAmount5');

    if (popupSavingsPreviewEl) popupSavingsPreviewEl.textContent = formatPrice(perItemSavings2);
    if (popupSavingsAmount2El) popupSavingsAmount2El.textContent = formatPrice(perItemSavings2);
    if (popupSavingsAmount3El) popupSavingsAmount3El.textContent = formatPrice(perItemSavings3);
    if (popupSavingsAmount5El) popupSavingsAmount5El.textContent = formatPrice(perItemSavings5);

    // Reset savings selections
    document.querySelectorAll('.popup-savings-option').forEach(option => {
        option.classList.remove('selected');
    });

    // Update related products section with new recommendations
    updateRelatedProducts();

    // Update left column related products
    updateLeftColumnRelatedProducts();
}

function proceedToCheckout() {
    // Validate minimum order before proceeding
    if (currentCartTotal < MINIMUM_ORDER_VALUE) {
        showMinimumOrderModal();
        return;
    }

    // Additional validation - check for automatic coupon codes
    validateCartAndProceed();
}

function validateCartAndProceed() {
    // Fetch current cart to check for automatic discounts
    fetch('/cart.js')
    .then(response => response.json())
    .then(cart => {
        // Update current total in case automatic coupons were applied
        currentCartTotal = cart.total_price;

        // Check again after potential coupon application
        if (currentCartTotal < MINIMUM_ORDER_VALUE) {
            showMinimumOrderModal();
            return;
        }

        // Proceed to checkout
        window.location.href = '/checkout';
    })
    .catch(error => {
        console.error('Error validating cart:', error);
        // Proceed anyway if validation fails
        window.location.href = '/checkout';
    });
}

function showMinimumOrderModal() {
    const remaining = MINIMUM_ORDER_VALUE - currentCartTotal;

    // Create modal HTML
    const modalHTML = `
        <div class="popup-validation-modal" id="popup-validation-modal">
            <div class="popup-validation-overlay" onclick="closeValidationModal()"></div>
            <div class="popup-validation-content">
                <div class="popup-validation-header">
                    <h3>üõí Minimum Order Required</h3>
                    <button class="popup-validation-close" onclick="closeValidationModal()">√ó</button>
                </div>
                <div class="popup-validation-body">
                    <div class="validation-info">
                        <p><strong>Current Total:</strong> $${(currentCartTotal / 100).toFixed(2)}</p>
                        <p><strong>Required Minimum:</strong> $${(MINIMUM_ORDER_VALUE / 100).toFixed(2)}</p>
                        <p class="amount-needed"><strong>Amount Needed:</strong> $${(remaining / 100).toFixed(2)}</p>
                    </div>
                    <div class="security-notice">
                        <div class="security-icon">üõ°Ô∏è</div>
                        <span class="security-text">This validation is enforced server-side and cannot be bypassed. Your cart must meet the minimum order requirement to proceed.</span>
                    </div>
                </div>
                <div class="popup-validation-footer">
                    <button class="validation-btn primary" onclick="continueShopping()">üõçÔ∏è Continue Shopping</button>
                    <button class="validation-btn secondary" onclick="closeValidationModal()">Cancel</button>
                </div>
            </div>
        </div>
    `;

    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modalHTML);

    // Show modal
    const modal = document.getElementById('popup-validation-modal');
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
}

function closeValidationModal() {
    const modal = document.getElementById('popup-validation-modal');
    if (modal) {
        modal.remove();
    }
    document.body.style.overflow = 'auto';
}

function continueShopping() {
    closeAddToCartPopup();
}

function addRelatedProduct(sku, title, price) {
    // Add related product to cart
    fetch('/cart/add.js', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            id: sku, // You may need to map SKU to variant ID
            quantity: 1
        })
    })
    .then(response => response.json())
    .then(data => {
        showAddToCartSuccess();
    })
    .catch(error => {
        console.error('Error adding related product:', error);
        showAddToCartError();
    });
}

// Function to copy collection title URL to clipboard
function copyCollectionURL(event, anchorId, title) {
    event.preventDefault();
    event.stopPropagation();

    const fullURL = window.location.origin + window.location.pathname + '#' + anchorId;

    navigator.clipboard.writeText(fullURL)
        .then(() => {
            // Show toast notification
            const toast = document.createElement('div');
            toast.classList.add('toast');
            toast.textContent = 'Collection URL copied: ' + title;
            document.body.appendChild(toast);

            // Animate toast
            setTimeout(() => {
                toast.classList.add('show');
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => {
                        if (document.body.contains(toast)) {
                            document.body.removeChild(toast);
                        }
                    }, 300);
                }, 3000);
            }, 100);
        })
        .catch(err => {
            console.error('Could not copy URL: ', err);
            // Fallback toast for error
            const errorToast = document.createElement('div');
            errorToast.classList.add('toast');
            errorToast.textContent = 'Failed to copy URL. Please try again.';
            errorToast.style.background = '#dc3545';
            document.body.appendChild(errorToast);
            setTimeout(() => {
                errorToast.classList.add('show');
                setTimeout(() => {
                    errorToast.classList.remove('show');
                    setTimeout(() => {
                        if (document.body.contains(errorToast)) {
                            document.body.removeChild(errorToast);
                        }
                    }, 300);
                }, 2000);
            }, 100);
        });
}

// Start countdown when page loads
document.addEventListener('DOMContentLoaded', function() {
  updateCountdown();
  calculatePricesAndSavings();

  // Initialize cart info
  updateCartInfo();

  // Handle URL hash navigation on page load
  handleHashNavigation();

  // Handle hash changes (when user navigates back/forward)
  window.addEventListener('hashchange', handleHashNavigation);
});

// Function to handle URL hash navigation
function handleHashNavigation() {
  const hash = window.location.hash;
  if (hash) {
    const targetElement = document.querySelector(hash);
    if (targetElement) {
      // Small delay to ensure page is fully loaded
      setTimeout(() => {
        targetElement.scrollIntoView({
          behavior: 'smooth',
          block: 'start'
        });
      }, 100);
    }
  }
}

// Function to add product directly to cart
function addToCartDirect(productId) {
  const quantityInput = document.getElementById(`quantity-${productId}`);
  const quantity = parseInt(quantityInput.value);

  // Get variant ID
  const variantSelect = document.getElementById(`variant-select-${productId}`);
  let variantId;

  if (variantSelect) {
      variantId = variantSelect.value;
  } else {
      // If no variant selector, assume the first variant
      const productCard = document.querySelector(`.product-card`);
      if (productCard) {
        variantId = productCard.querySelector(`.variant-selector option`).value;
      } else {
        console.warn('Variant select not found for product', productId);
        return;
      }
  }

  // Add to cart via AJAX
  fetch('/cart/add.js', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      id: variantId,
      quantity: quantity
    })
  })
  .then(response => response.json())
  .then(data => {
    // Show success message
    showAddToCartSuccess();

    // Update header cart count immediately
    updateHeaderCartCount();

    // Update cart info
    updateCartInfo();
  })
  .catch(error => {
    console.error('Error adding to cart:', error);
    showAddToCartError();
  });
}
</script>

<div class="overlay" id="overlay"></div>

<div class="add-to-cart-popup" id="addToCartPopup">
    <div class="popup-content">
        <div class="popup-left-column" id="leftRelatedProducts">
            <h3>‚ú® Pair it with...</h3>
            <div class="popup-left-products" id="leftRelatedProductsGrid">
                <!-- Related product recommendations on left -->
            </div>
        </div>

        <div class="popup-main-content">
            <div class="popup-header">
                <h2>Add to Cart</h2>
                <span class="popup-close" onclick="closeAddToCartPopup()">√ó</span>
            </div>

            <div class="popup-product-details">
                <div class="popup-product-image">
                    <img id="popupProductImage" src="" alt="Product Image">
                    <div class="discount-badge" id="popupDiscountBadge">25% OFF</div>
                </div>

                <div class="popup-product-info">
                    <h3 id="popupProductTitle">Product Title</h3>
                    <p>SKU: <span id="popupProductSKU"></span></p>
                    <div class="popup-product-prices">
                        <span class="original-price" id="popupOriginalPrice">$99.99</span>
                        <span class="sale-price" id="popupSalePrice">$79.99</span>
                        <span class="final-price">Now: <span id="popupFinalPrice">$59.99</span></span>
                    </div>
                </div>
            </div>

            <div class="popup-quantity-controls">
                <h3>Select Quantity</h3>
                <div class="quantity-input-wrapper">
                    <button type="button" onclick="decreaseQuantity()">‚àí</button>
                    <input type="number" id="popupQuantity" value="1" min="1">
                    <button type="button" onclick="increaseQuantity()">+</button>
                </div>
            </div>

            <div class="popup-savings">
                <h3>üí∞ Smart Savings</h3>

                <div class="popup-savings-options">
                    <div class="popup-savings-option popup-savings-1 selected" onclick="selectSavingsOption(1)">
                        <div class="savings-preview">
                            1 item
                            <span class="arrow">‚Üí</span>
                            <span class="savings-preview-price">$<span id="popupSavingsPreview"></span></span>
                        </div>
                    </div>

                    <div class="popup-savings-option popup-savings-2" onclick="selectSavingsOption(2)">
                        <div class="savings-preview">
                            <div class="savings-content">
                                2+ items
                                <span class="arrow">‚Üí</span>
                                <span class="savings-preview-price">$<span id="popupSavingsAmount2"></span> each</span>
                            </div>
                            <button class="savings-toggle" onclick="togglePopupSavings(this)">+</button>
                        </div>

                        <div class="savings-expanded">
                            <ul class="savings-details">
                                <li>Each: $<span class="savings-amount"></span></li>
                                <li>Total: $<span class="total-price"></span></li>
                                <li>You save: $<span class="total-savings"></span></li>
                            </ul>
                        </div>
                    </div>

                    <div class="popup-savings-option popup-savings-3" onclick="selectSavingsOption(3)">
                        <div class="savings-preview">
                            <div class="savings-content">
                                3+ items
                                <span class="arrow">‚Üí</span>
                                <span class="savings-preview-price">$<span id="popupSavingsAmount3"></span> each</span>
                            </div>
                            <button class="savings-toggle" onclick="togglePopupSavings(this)">+</button>
                        </div>

                        <div class="savings-expanded">
                            <ul class="savings-details">
                                <li>Each: $<span class="savings-amount"></span></li>
                                <li>Total: $<span class="total-price"></span></li>
                                <li>You save: $<span class="total-savings"></span></li>
                            </ul>
                        </div>
                    </div>

                    <div class="popup-savings-option popup-savings-5" onclick="selectSavingsOption(5)">
                        <div class="savings-preview">
                            <div class="savings-content">
                                5+ items
                                <span class="arrow">‚Üí</span>
                                <span class="savings-preview-price">$<span id="popupSavingsAmount5"></span> each</span>
                            </div>
                            <button class="savings-toggle" onclick="togglePopupSavings(this)">+</button>
                        </div>

                        <div class="savings-expanded">
                            <ul class="savings-details">
                                <li>Each: $<span class="savings-amount"></span></li>
                                <li>Total: $<span class="total-price"></span></li>
                                <li>You save: $<span class="total-savings"></span></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <div class="popup-add-to-cart-area">
                <button class="popup-add-to-cart" onclick="addToCart()">Add to Cart</button>
                <!-- Validation Warning Container -->
                <div id="validation-warning-container"></div>
            </div>
        </div>
    </div>
</div>