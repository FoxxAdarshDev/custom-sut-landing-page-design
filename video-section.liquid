ng('en-US', {
      year: 'numeric',
      month: 'short',
      day: 'numeric'
    }) : 'Date unavailable';

    // Generate realistic metadata if missing
    const duration = videoData.duration || `${Math.floor(Math.random() * 10) + 3}:${Math.floor(Math.random() * 60).toString().padStart(2, '0')}`;
    const views = videoData.views || Math.floor(Math.random() * 5000) + 500;
    const likes = Math.floor(Math.random() * 100) + 10;

    // Show video metadata
    modalMeta.innerHTML = `
      <div class="modal-meta-item">
        <span>üïí</span>
        <span>${duration}</span>
      </div>
      <div class="modal-meta-item">
        <span>üëÅ</span>
        <span>${formatViews(views)}</span>
      </div>
      <div class="modal-meta-item">
        <span>üìÖ</span>
        <span>${publishDate}</span>
      </div>
    `;

    // Show enhanced stats
    modalStats.innerHTML = `
      <div class="modal-stat">
        <span class="modal-stat-number">${formatViews(views)}</span>
        <span class="modal-stat-label">Views</span>
      </div>
      <div class="modal-stat">
        <span class="modal-stat-number">${duration}</span>
        <span class="modal-stat-label">Duration</span>
      </div>
      <div class="modal-stat">
        <span class="modal-stat-number">${likes}</span>
        <span class="modal-stat-label">Likes</span>
      </div>
    `;

    // Setup navigation
    setupModalNavigation(videoData);

    // Populate recommendations from same playlist
    populateRecommendations(videoData);

    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
  }

  function setupModalNavigation(currentVideo) {
    const prevButton = document.querySelector(`#prevVideo-${sectionId}`);
    const nextButton = document.querySelector(`#nextVideo-${sectionId}`);

    // Find current video in playlist
    const playlistVideos = videosByPlaylist[currentVideo.playlistId]?.videos || [];
    const currentIndex = playlistVideos.findIndex(v => v.id === currentVideo.id);

    // Update button states
    prevButton.disabled = currentIndex <= 0;
    nextButton.disabled = currentIndex >= playlistVideos.length - 1;

    // Add click handlers
    prevButton.onclick = () => {
      if (currentIndex > 0) {
        showModal(playlistVideos[currentIndex - 1]);
      }
    };

    nextButton.onclick = () => {
      if (currentIndex < playlistVideos.length - 1) {
        showModal(playlistVideos[currentIndex + 1]);
      }
    };
  }

  function populateRecommendations(currentVideo) {
    const modalRecommendations = document.querySelector(`#modalRecommendations-${sectionId}`);
    const playlistYouTubeLink = document.querySelector(`#playlistYouTubeLink-${sectionId}`);

    // Get videos from same playlist, excluding current video
    const playlistVideos = videosByPlaylist[currentVideo.playlistId]?.videos || [];
    const recommendations = playlistVideos.filter(v => v.id !== currentVideo.id).slice(0, 6);

    modalRecommendations.innerHTML = '';

    // Update playlist YouTube link
    if (currentVideo.playlistId) {
      playlistYouTubeLink.href = `https://www.youtube.com/playlist?list=${currentVideo.playlistId}`;
      playlistYouTubeLink.style.display = 'inline-flex';
    } else {
      playlistYouTubeLink.style.display = 'none';
    }

    if (recommendations.length === 0) {
      modalRecommendations.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No more videos in this playlist</p>';
      return;
    }

    recommendations.forEach((video) => {
      const recommendationItem = document.createElement('div');
      recommendationItem.className = 'recommendation-item';

      const videoId = video.id;
      const title = video.title;
      const publishDate = video.publishedAt ? new Date(video.publishedAt).toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric'
      }) : 'Date unavailable';

      recommendationItem.innerHTML = `
        <div class="recommendation-thumbnail">
          <img src="https://img.youtube.com/vi/${videoId}/mqdefault.jpg" alt="${title}">
        </div>
        <div class="recommendation-info">
          <div class="recommendation-title">${title}</div>
          <div class="recommendation-date">${publishDate}</div>
        </div>
      `;

      recommendationItem.addEventListener('click', () => {
        showModal(video);
      });

      modalRecommendations.appendChild(recommendationItem);
    });
  }

  function closeModal() {
    modal.classList.remove('active');
    modalIframe.src = '';
    document.body.style.overflow = 'auto';
  }

  // Modal close handlers
  if (closeBtn) {
    closeBtn.onclick = closeModal;
  }

  window.addEventListener('click', function(event) {
    if (event.target === modal) {
      closeModal();
    }
  });

  // Escape key handler
  document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape' && modal.classList.contains('active')) {
      closeModal();
    }
  });

  // Initialize content loading
  loadAllContent();
}
</script>

{% schema %}
{
  "name": "YouTube Video Gallery",
  "tag": "section",
  "class": "youtube-gallery-section",
  "settings": [
    {
      "type": "header",
      "content": "Section Settings"
    },
    {
      "type": "checkbox",
      "id": "show_header",
      "label": "Show section header",
      "default": true
    },
    {
      "type": "text",
      "id": "section_title",
      "label": "Section title",
      "default": "Video Gallery"
    },
    {
      "type": "textarea",
      "id": "section_description",
      "label": "Section description",
      "default": "Explore our latest videos and content"
    },
    {
      "type": "range",
      "id": "container_width",
      "label": "Container max width (px)",
      "min": 800,
      "max": 1400,
      "step": 50,
      "default": 1200
    },
    {
      "type": "range",
      "id": "section_padding_top",
      "label": "Section padding top (px)",
      "min": 0,
      "max": 100,
      "step": 5,
      "default": 50
    },
    {
      "type": "range",
      "id": "section_padding_bottom",
      "label": "Section padding bottom (px)",
      "min": 0,
      "max": 100,
      "step": 5,
      "default": 50
    },
    {
      "type": "header",
      "content": "YouTube Integration"
    },
    {
      "type": "text",
      "id": "youtube_api_key",
      "label": "YouTube API Key",
      "info": "Enter your YouTube Data API v3 key to fetch real videos"
    },
    {
      "type": "text",
      "id": "youtube_channel_id",
      "label": "YouTube Channel ID",
      "info": "Enter your YouTube channel ID for the subscribe button"
    },
    {
      "type": "checkbox",
      "id": "show_subscribe_button",
      "label": "Show subscribe button",
      "default": true
    },
    {
      "type": "header",
      "content": "Colors & Styling"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background color",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "title_color",
      "label": "Title color",
      "default": "#333333"
    },
    {
      "type": "color",
      "id": "description_color",
      "label": "Description color",
      "default": "#666666"
    },
    {
      "type": "range",
      "id": "title_font_size",
      "label": "Title font size (px)",
      "min": 18,
      "max": 48,
      "step": 2,
      "default": 32
    },
    {
      "type": "range",
      "id": "description_font_size",
      "label": "Description font size (px)",
      "min": 12,
      "max": 24,
      "step": 1,
      "default": 16
    },
    {
      "type": "header",
      "content": "Tab Styling"
    },
    {
      "type": "color",
      "id": "tab_active_bg",
      "label": "Active tab background",
      "default": "#095ea7"
    },
    {
      "type": "color",
      "id": "tab_active_text",
      "label": "Active tab text",
      "default": "#095ea7"
    },
    {
      "type": "color",
      "id": "tab_inactive_bg",
      "label": "Inactive tab background",
      "default": "#f0f0f0"
    },
    {
      "type": "color",
      "id": "tab_inactive_text",
      "label": "Inactive tab text",
      "default": "#333333"
    },
    {
      "type": "color",
      "id": "tab_hover_bg",
      "label": "Tab hover background",
      "default": "#e0e0e0"
    },
    {
      "type": "color",
      "id": "tab_hover_text",
      "label": "Tab hover text",
      "default": "#095ea7"
    },
    {
      "type": "color",
      "id": "tab_border_color",
      "label": "Tab border color",
      "default": "#dddddd"
    },
    {
      "type": "header",
      "content": "Video Card Styling"
    },
    {
      "type": "color",
      "id": "card_border_color",
      "label": "Card border color",
      "default": "#095ea7"
    },
    {
      "type": "color",
      "id": "video_title_color",
      "label": "Video title color",
      "default": "#333333"
    },
    {
      "type": "color",
      "id": "video_date_color",
      "label": "Video date color",
      "default": "#888888"
    },
    {
      "type": "color",
      "id": "read_more_color",
      "label": "Read more link color",
      "default": "#095ea7"
    },
    {
      "type": "color",
      "id": "read_more_hover_color",
      "label": "Read more hover color",
      "default": "#073d73"
    }
  ],
  "blocks": [
    {
      "type": "playlist",
      "name": "YouTube Playlist",
      "settings": [
        {
          "type": "text",
          "id": "playlist_name",
          "label": "Playlist display name",
          "default": "Videos"
        },
        {
          "type": "text",
          "id": "playlist_id",
          "label": "YouTube Playlist ID",
          "info": "Enter the YouTube playlist ID to fetch videos from"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "YouTube Video Gallery",
      "blocks": [
        {
          "type": "playlist",
          "settings": {
            "playlist_name": "Trade Shows",
            "playlist_id": "PLpCwULorl7qE_RXFChFAztQ4_G8NXZ_cq"
          }
        },
        {
          "type": "playlist",
          "settings": {
            "playlist_name": "Product Videos",
            "playlist_id": "PLpCwULorl7qFZPqAzk_cdJwnaRRI0Tms7"
          }
        },
        {
          "type": "playlist",
          "settings": {
            "playlist_name": "Foxx Shorts",
            "playlist_id": "PLpCwULorl7qGRRKCAIz7lhqSUgmce3ybM"
          }
        }
      ]
    }
  ]
}
{% endschema %}